<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë§ì”€ ì„±ê²½</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #faf8f3;
  --bg2:      #f3ede2;
  --bg3:      #e8e0d0;
  --surface:  #ffffff;
  --brown:    #6b4f2e;
  --brown2:   #4a3318;
  --amber:    #c07830;
  --amber-l:  #f0d4a8;
  --amber-ll: #fdf5e8;
  --text:     #2a2018;
  --text2:    #6e5c44;
  --text3:    #a89880;
  --border:   #ddd5c2;
  --border2:  #ede7d8;
  --sh:       0 2px 10px rgba(80,55,20,.07);
  --sh2:      0 4px 20px rgba(80,55,20,.12);
  --r:        13px;
  --tr:       .2s cubic-bezier(.4,0,.2,1);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}

/* â•â•â• í—¤ë” â•â•â• */
.hdr{
  position:sticky;top:0;z-index:200;
  background:rgba(250,248,243,.95);
  backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
  border-bottom:1.5px solid var(--border);
  height:56px;display:flex;align-items:center;padding:0 14px;gap:8px;
}
.hdr-btn{
  width:36px;height:36px;border-radius:9px;border:1.5px solid var(--border);
  background:var(--surface);color:var(--text2);cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:15px;
  transition:var(--tr);flex-shrink:0;
}
.hdr-btn:hover{background:var(--amber-ll);border-color:var(--amber);color:var(--amber)}
.hdr-btn:disabled{opacity:.3;cursor:default;pointer-events:none}
.hdr-title{
  flex:1;text-align:center;
  font-family:'Noto Serif KR',serif;font-size:17px;font-weight:700;
  color:var(--brown2);letter-spacing:1px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.hdr-title.logo-mode{letter-spacing:3px;font-size:20px}

/* ì½ê¸° í—¤ë”ìš© AI ìš”ì•½ ë²„íŠ¼ */
.hdr-ai-btn{
  display:flex;align-items:center;gap:5px;
  padding:6px 11px;border-radius:18px;
  background:linear-gradient(135deg,#fdf0d8,#fbe3b8);
  border:1.5px solid var(--amber);
  color:var(--amber);font-size:11px;font-weight:700;
  cursor:pointer;transition:var(--tr);white-space:nowrap;flex-shrink:0;
}
.hdr-ai-btn:hover{background:var(--amber);color:#fff}

/* â•â•â• íƒ­ë°” (ê²€ìƒ‰ íƒ­ ì œê±°ë¨) â•â•â• */
.tabbar{
  display:flex;background:var(--surface);
  border-bottom:1.5px solid var(--border);padding:0 8px;
  position:sticky;top:56px;z-index:190;
}
.tab{
  flex:1;padding:12px 2px 10px;border:none;background:none;
  color:var(--text3);cursor:pointer;
  font-family:'Noto Sans KR',sans-serif;font-size:13px;font-weight:600;
  border-bottom:2.5px solid transparent;transition:var(--tr);
}
.tab.on{color:var(--brown);border-bottom-color:var(--amber)}

/* â•â•â• í˜ì´ì§€ â•â•â• */
.page{display:none}.page.on{display:block}

/* â•â•â• ë©”ì¸ í™”ë©´ (í™ˆ) â•â•â• */
.home-hero{
  background:linear-gradient(160deg,#fff8ee 0%,#f5e8d0 100%);
  padding:32px 20px 24px;
  border-bottom:1.5px solid var(--border2);
  text-align:center;
}
.home-cross{font-size:32px;margin-bottom:8px;opacity:.7}
.home-title{font-family:'Noto Serif KR',serif;font-size:28px;font-weight:700;color:var(--brown2);letter-spacing:4px;margin-bottom:6px}
.home-sub{font-size:12px;color:var(--text3);letter-spacing:1px}

/* êµ¬ì•½/ì‹ ì•½ íƒ­ */
.testament-row{display:flex;gap:8px;padding:14px 14px 8px}
.t-btn{
  flex:1;padding:10px 0;border:1.5px solid var(--border);border-radius:10px;
  background:var(--surface);color:var(--text2);cursor:pointer;
  font-family:'Noto Serif KR',serif;font-size:14px;font-weight:600;transition:var(--tr);
}
.t-btn.on{background:var(--brown2);border-color:var(--brown2);color:#fff}

/* ì±… ê·¸ë¦¬ë“œ */
.book-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;padding:4px 12px 80px}
.book-card{
  background:var(--surface);border:1.5px solid var(--border2);
  border-radius:var(--r);padding:13px 8px 10px;
  cursor:pointer;text-align:center;transition:var(--tr);
  position:relative;box-shadow:var(--sh);
}
.book-card:hover{border-color:var(--amber);background:var(--amber-ll);transform:translateY(-2px);box-shadow:var(--sh2)}
.book-abbr{font-family:'Noto Serif KR',serif;font-size:17px;font-weight:700;color:var(--brown2);display:block;margin-bottom:2px}
.book-name{font-size:10px;color:var(--text3)}

/* â•â•â• ì¥/ì ˆ ì„ íƒ í™”ë©´ (ëª¨ë°”ì¼ ê°€ë…ì„± ê°œì„  & ë„¤ëª¨ì¹¸ ì¶•ì†Œ) â•â•â• */
.sec-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 14px 12px;
}
.sec-title{font-family:'Noto Serif KR',serif;font-size:16px;font-weight:700;color:var(--brown2)}
.ai-pill{
  display:flex;align-items:center;gap:5px;
  padding:7px 13px;border-radius:18px;
  background:linear-gradient(135deg,#fdf0d8,#fbe3b8);
  border:1.5px solid var(--amber);
  color:var(--amber);font-size:11px;font-weight:700;
  cursor:pointer;transition:var(--tr);white-space:nowrap;
}

/* í•µì‹¬ ìˆ˜ì •: auto-fillê³¼ minmaxë¥¼ ì¨ì„œ ëª¨ë°”ì¼ í™”ë©´ì— ë§ê²Œ ì‘ì€ ë°•ìŠ¤ë“¤ì´ ì´˜ì´˜íˆ ë°°ì—´ë˜ë„ë¡ í•¨ */
.ch-grid, .v-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(42px, 1fr)); 
  gap: 8px;
  padding: 4px 14px 80px;
}
.ch-btn, .v-btn {
  aspect-ratio: 1;
  border-radius: 8px;
  background: var(--surface);
  border: 1.5px solid var(--border2);
  color: var(--text2);
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  display: flex; align-items: center; justify-content: center;
  transition: var(--tr); box-shadow: var(--sh);
}
.ch-btn:hover, .v-btn:hover {background:var(--amber-ll);border-color:var(--amber);color:var(--brown2);transform:scale(1.05)}

/* â•â•â• ì½ê¸° í™”ë©´ (ëª¨ë°”ì¼ ê°€ë…ì„±) â•â•â• */
.verses-wrap{padding:14px 14px 90px}
.verse-row{
  display:flex;gap:12px;padding:12px 10px;border-radius:10px;
  transition:background .2s,opacity .3s;cursor:pointer;
  border-left:3px solid transparent; margin-bottom: 6px;
}
.verse-row.hl{background:rgba(192,120,48,.08);border-left-color:var(--amber)}
.verse-row.dim{opacity:.25}
.verse-row:hover{background:rgba(192,120,48,.05)}
.vn{
  font-size:12px;color:var(--amber);font-weight:700;
  min-width:22px;padding-top:5px;flex-shrink:0;text-align:right;
}
.vt{
  font-family:'Noto Serif KR',serif;
  font-size:17px;line-height:1.8;color:var(--text);flex:1;word-break:keep-all;
}
.v-acts{display:none;flex-direction:column;gap:6px;align-items:flex-end;flex-shrink:0;padding-top:4px}
.verse-row:hover .v-acts,.verse-row.hl .v-acts{display:flex}
.v-act-btn{
  display:flex;align-items:center;gap:3px;
  padding:6px 10px;border-radius:8px;
  background:var(--bg2);border:1.5px solid var(--border);
  color:var(--text3);cursor:pointer;font-size:11px;font-weight:600;
  transition:var(--tr);white-space:nowrap;
}
.v-act-btn:hover{background:var(--amber-ll);border-color:var(--amber);color:var(--amber)}
.v-act-btn.bm-on{background:var(--amber-ll);color:var(--amber);border-color:var(--amber)}

/* ì´ì „/ë‹¤ìŒ ì¥ */
.ch-nav{
  position:sticky;bottom:0;z-index:50;
  display:flex;gap:10px;padding:12px 14px;
  background:rgba(250,248,243,.96);backdrop-filter:blur(10px);
  border-top:1.5px solid var(--border);
}
.ch-nav-btn{
  flex:1;padding:12px;border-radius:10px;
  background:var(--surface);border:1.5px solid var(--border);
  color:var(--text2);cursor:pointer;font-size:14px;font-weight:600;
  transition:var(--tr);
}
.ch-nav-btn:hover:not(:disabled){border-color:var(--amber);color:var(--brown);background:var(--amber-ll)}
.ch-nav-btn:disabled{opacity:.3;cursor:default}

/* â•â•â• ë¶ë§ˆí¬ â•â•â• */
.bm-list{padding:14px;display:flex;flex-direction:column;gap:10px}
.bm-item{
  display:flex;align-items:flex-start;gap:12px;
  padding:14px;background:var(--surface);
  border:1.5px solid var(--border2);border-radius:var(--r);
  cursor:pointer;box-shadow:var(--sh);transition:var(--tr);
}
.bm-item:hover{border-color:var(--amber);box-shadow:var(--sh2)}
.bm-ico{color:var(--amber);font-size:18px;flex-shrink:0;padding-top:2px}
.bm-ref{font-size:12px;color:var(--amber);font-weight:700;margin-bottom:6px}
.bm-txt{font-family:'Noto Serif KR',serif;font-size:15px;color:var(--text2);line-height:1.6;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.bm-del{width:30px;height:30px;border-radius:8px;background:transparent;border:none;color:var(--text3);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:var(--tr)}
.bm-del:hover{color:#e04;background:rgba(220,0,60,.08)}
.empty-box{text-align:center;padding:60px 20px;color:var(--text3);font-family:'Noto Serif KR',serif}
.empty-ico{font-size:42px;margin-bottom:12px;opacity:.3}

/* â•â•â• ì„¤ì • â•â•â• */
.set-sec{padding:16px 14px}
.set-sec h4{font-size:12px;color:var(--text3);letter-spacing:2px;margin-bottom:12px;font-weight:600;text-transform:uppercase}
.set-card{background:var(--surface);border:1.5px solid var(--border2);border-radius:var(--r);padding:16px;margin-bottom:10px;box-shadow:var(--sh)}
.set-card label{font-size:15px;color:var(--text);font-weight:600}
.set-hint{font-size:12px;color:var(--text3);margin-top:6px;line-height:1.55}

/* â•â•â• AI ì‹œíŠ¸ â•â•â• */
.overlay{position:fixed;inset:0;background:rgba(40,28,12,.38);z-index:300;opacity:0;pointer-events:none;transition:opacity .3s}
.overlay.on{opacity:1;pointer-events:all}
.ai-sheet{
  position:fixed;bottom:0;left:0;right:0;z-index:310;
  background:var(--surface);
  border-radius:24px 24px 0 0;
  border-top:2px solid var(--amber-l);
  box-shadow:0 -6px 40px rgba(80,50,10,.18);
  transform:translateY(108%);
  transition:transform .4s cubic-bezier(.32,1.2,.6,1);
  max-height:80vh;display:flex;flex-direction:column;
  padding-bottom:env(safe-area-inset-bottom,16px);
}
.ai-sheet.on{transform:translateY(0)}
.sh-handle{width:40px;height:5px;border-radius:3px;background:var(--border);margin:12px auto 0;flex-shrink:0}
.sh-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 20px 12px;flex-shrink:0;border-bottom:1px solid var(--border2)}
.sh-title-wrap{display:flex;flex-direction:column;gap:4px}
.sh-title{font-family:'Noto Serif KR',serif;font-size:17px;font-weight:700;color:var(--brown2)}
.sh-badge{font-size:11px;color:var(--amber);font-weight:700;letter-spacing:.5px}
.sh-close{width:32px;height:32px;border-radius:50%;background:var(--bg2);border:1.5px solid var(--border);color:var(--text3);cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;transition:var(--tr)}
.sh-body{padding:16px 20px 24px;overflow-y:auto;flex:1;font-family:'Noto Serif KR',serif;font-size:16px;line-height:1.9;color:var(--text)}

.dots{display:inline-flex;gap:5px;align-items:center}
.dots span{width:7px;height:7px;border-radius:50%;background:var(--amber);animation:db .9s infinite ease-in-out}
.dots span:nth-child(2){animation-delay:.18s}.dots span:nth-child(3){animation-delay:.36s}
@keyframes db{0%,80%,100%{transform:scale(.45)}40%{transform:scale(1)}}

/* â•â•â• í† ìŠ¤íŠ¸ â•â•â• */
.toast{
  position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(14px);
  background:var(--brown2);border-radius:20px;color:#fff;
  padding:10px 24px;font-size:14px;font-weight:500;
  z-index:400;opacity:0;transition:all .28s;pointer-events:none;white-space:nowrap;
  box-shadow:0 4px 16px rgba(44,28,8,.2);
}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0)}

::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
</style>
</head>
<body>

<div class="hdr" id="hdr">
  <button class="hdr-btn" id="btnHome" title="í™ˆ">ğŸ </button>
  <button class="hdr-btn" id="btnBack" title="ë’¤ë¡œ" disabled>â†</button>
  <div class="hdr-title logo-mode" id="hdrTitle">âœ ë§ì”€</div>
  <button class="hdr-ai-btn" id="hdrAiBtn" style="display:none">âœ¨ ìƒí™©ë³„ AI ìš”ì•½</button>
  <button class="hdr-btn" id="btnBm" title="ë¶ë§ˆí¬">ğŸ”–</button>
</div>

<div class="tabbar">
  <button class="tab on" data-tab="bible">ì„±ê²½</button>
  <button class="tab" data-tab="bookmarks">ë¶ë§ˆí¬</button>
  <button class="tab" data-tab="settings">ì„¤ì •</button>
</div>

<div id="bible-page" class="page on">

  <div id="vHome">
    <div class="home-hero">
      <div class="home-cross">âœ</div>
      <div class="home-title">ë§ì”€</div>
      <div class="home-sub">ê°œì—­í•œê¸€ ì„±ê²½ (KRV)</div>
    </div>

    <div class="testament-row">
      <button class="t-btn on" data-t="old">êµ¬ì•½ 39ê¶Œ</button>
      <button class="t-btn" data-t="new">ì‹ ì•½ 27ê¶Œ</button>
    </div>
    <div class="book-grid" id="bookGrid"></div>
  </div>

  <div id="vChapter" style="display:none">
    <div class="sec-header">
      <div class="sec-title" id="chTitle">ì°½ì„¸ê¸° â€” ì¥ ì„ íƒ</div>
      <button class="ai-pill" id="bookAiBtn">âœ¨ ì´ ì±… ìŠ¤í† ë¦¬ ìš”ì•½</button>
    </div>
    <div class="ch-grid" id="chGrid"></div>
  </div>

  <div id="vVerse" style="display:none">
    <div class="sec-header">
      <div class="sec-title" id="vTitle">ì°½ì„¸ê¸° 1ì¥ â€” ì ˆ ì„ íƒ</div>
      <button class="ai-pill" id="chapAiBtn">âœ¨ ì´ ì¥ í•µì‹¬ ìš”ì•½</button>
    </div>
    <div class="v-grid" id="vGrid"></div>
  </div>

  <div id="vRead" style="display:none">
    <div class="verses-wrap" id="versesWrap"></div>
    <div class="ch-nav">
      <button class="ch-nav-btn" id="prevBtn">â€¹ ì´ì „ ì¥</button>
      <button class="ch-nav-btn" id="nextBtn">ë‹¤ìŒ ì¥ â€º</button>
    </div>
  </div>

</div>

<div id="bookmarks-page" class="page">
  <div class="bm-list" id="bmList"></div>
</div>

<div id="settings-page" class="page">
  <div class="set-sec">
    <h4>ì•± ì •ë³´</h4>
    <div class="set-card">
      <label>ë°ì´í„° ì¶œì²˜</label>
      <div class="set-hint">Cloudflare KV ìŠ¤í† ë¦¬ì§€ì—ì„œ ë³¸ë¬¸ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</div>
    </div>
  </div>
  <div class="set-sec">
    <h4>ë¶ë§ˆí¬ ê´€ë¦¬</h4>
    <div class="set-card" style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <label>ë¶ë§ˆí¬ ì „ì²´ ì‚­ì œ</label>
        <div class="set-hint">ì €ì¥ëœ ëª¨ë“  ë¶ë§ˆí¬ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤</div>
      </div>
      <button id="clearBmBtn" style="padding:10px 16px;border-radius:10px;background:#fee;border:1.5px solid #fcc;color:#c33;font-size:13px;font-weight:700;cursor:pointer">ì‚­ì œ</button>
    </div>
  </div>
</div>

<div class="overlay" id="overlay"></div>
<div class="ai-sheet" id="aiSheet">
  <div class="sh-handle"></div>
  <div class="sh-hdr">
    <div class="sh-title-wrap">
      <div class="sh-title" id="shTitle">AI ë§ì¶¤ í•´ì„¤</div>
      <div class="sh-badge" id="shBadge">ìƒí™©ë³„ ìš”ì•½</div>
    </div>
    <button class="sh-close" id="shClose">âœ•</button>
  </div>
  <div class="sh-body" id="shBody"></div>
</div>

<div class="toast" id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   1. ì›ë³¸ ë³µêµ¬: ì„±ê²½ 66ê¶Œ ì „ì²´ ì ˆ ìˆ˜ (KRV)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const VC = {
  gen:[31,25,24,26,32,22,24,22,29,32,32,20,18,24,21,16,27,33,38,18,34,24,20,67,34,35,46,22,35,43,55,32,20,31,29,43,36,30,23,23,57,38,34,34,28,34,31,22,33,26],
  exo:[22,25,22,31,23,30,25,32,35,29,10,51,22,31,27,36,16,27,25,26,36,31,33,18,40,37,21,43,46,38,18,35,23,35,35,38,29,31,43,38],
  lev:[17,16,17,35,19,30,38,36,24,20,47,8,59,57,33,34,16,30,24,16,34,4,24,16,24,5,26,5,6,30],
  num:[54,34,51,49,31,27,89,26,23,36,35,16,33,45,41,50,13,32,22,29,35,41,30,25,18,65,23,31,40,16,54,42,56,29,34,13],
  deu:[46,37,29,49,33,25,26,20,29,22,32,32,18,29,23,22,20,22,21,20,23,30,25,22,19,19,26,68,29,20,30,52,29,12],
  jos:[18,24,17,24,15,27,26,35,27,43,23,24,33,15,63,10,18,28,51,9,45,34,16,33],
  jdg:[36,23,31,24,31,40,25,35,57,18,40,15,25,20,20,31,13,31,30,48,25],
  rut:[22,23,18,22],
  "1sa":[28,36,21,22,12,21,17,22,27,27,15,25,23,52,35,23,58,30,24,42,15,23,29,22,44,25,12,25,11,31,13],
  "2sa":[27,32,39,12,25,23,29,18,13,19,27,31,39,33,37,23,29,33,43,26,22,51,39,25],
  "1ki":[53,46,28,34,18,38,51,66,28,29,43,33,34,31,34,34,24,46,21,43,29,53],
  "2ki":[18,25,27,44,27,33,20,29,37,36,21,21,25,29,38,20,41,37,37,21,26,20,37,20,30],
  "1ch":[54,55,24,43,26,81,40,40,44,14,47,40,14,17,29,43,27,17,19,8,30,19,32,31,31,32,34,21,30],
  "2ch":[17,18,17,22,14,42,22,18,31,19,23,16,22,15,19,14,19,34,11,37,20,12,21,27,28,23,9,27,36,27,21,33,25,33,27,23],
  ezr:[11,70,13,24,17,22,28,36,15,44],
  neh:[11,20,32,23,19,19,73,18,38,39,36,47,31],
  est:[22,28,23,31,29,41,26,38,22,23],
  job:[22,13,26,21,27,30,21,22,35,22,20,25,28,22,35,22,16,21,29,29,34,30,17,25,6,14,23,28,25,31,40,22,33,37,16,33,24,41,30,24,34,17],
  psa:[6,12,8,8,12,10,17,9,20,18,7,8,6,7,5,11,15,50,14,9,13,31,6,10,22,12,14,9,11,12,24,11,22,22,28,12,40,22,13,17,13,11,5,20,28,22,35,22,46,28,14,9,17,12,12,16,13,14,14,7,16,11,15,14,23,17,12,17,7,18,12,83,14,6,6,32,11,27,36,17,20,18,10,20,24,26,31,17,22,30,18,17,12,6,26,18,12,8,20,11,14,20,18,13,12,11,8,23,14,6,13,11,11,6,18,17,8,20,6,18,24,13,23,6,19,18,17,5,22,11,17,8,16,8,18,20,19,16,20,6,10,7,14,9,13,10,10,11,6,6],
  pro:[33,22,35,27,23,35,27,36,18,32,31,28,25,35,33,33,28,24,29,30,31,29,35,34,28,28,27,28,27,33,31],
  ecc:[18,26,22,16,20,12,29,17,18,20,10,14],
  sng:[17,17,11,16,16,13,13,14],
  isa:[31,22,26,6,30,13,25,22,21,34,16,6,22,32,9,14,14,7,25,6,17,25,18,23,12,21,13,29,24,33,9,20,24,17,10,22,38,22,8,31,29,25,28,28,25,13,15,22,26,11,23,15,12,17,13,12,21,14,21,22,11,12,19,12,25,24],
  jer:[19,37,25,31,31,30,34,22,26,25,23,17,27,22,21,21,27,23,15,18,14,30,40,10,38,24,22,17,32,24,40,44,26,22,19,32,21,28,18,16,18,22,13,30,5,28,7,47,39,46,64,34],
  lam:[22,22,66,22,22],
  ezk:[28,10,27,17,17,14,27,18,11,22,25,28,23,23,8,63,24,32,14,49,32,31,49,27,17,21,36,26,21,26,18,32,33,31,15,38,28,23,29,49,26,20,27,31,25,24,23,35],
  dan:[21,49,30,37,31,28,28,27,27,21,45,13],
  hos:[11,23,5,19,15,11,16,14,17,15,12,14,16,9],
  jol:[20,32,21],amo:[15,16,15,13,27,14,17,14,15],oba:[21],
  jon:[17,10,10,11],mic:[16,13,12,13,15,16,20],nah:[15,13,19],
  hab:[17,20,19],zep:[18,15,20],hag:[15,23],
  zec:[21,13,10,14,11,15,14,23,17,12,17,14,9,21],mal:[14,17,18,6],
  mat:[25,23,17,25,48,34,29,34,38,42,30,50,58,36,39,28,27,35,30,34,46,46,39,51,46,75,66,20],
  mrk:[45,28,35,41,43,56,37,38,50,52,33,44,37,72,47,20],
  luk:[80,52,38,44,39,49,50,56,62,42,54,59,35,35,32,31,37,43,48,47,38,71,56,53],
  jhn:[51,25,36,54,47,71,53,59,41,42,57,50,38,31,27,33,26,40,42,31,25],
  act:[26,47,26,37,42,15,60,40,43,48,30,25,52,28,41,40,34,28,41,38,40,30,35,27,27,32,44,31],
  rom:[32,29,31,25,21,23,25,39,33,21,36,21,14,26,33,25],
  "1co":[31,16,23,21,13,20,40,13,27,33,34,31,13,40,58,24],
  "2co":[24,17,18,18,21,18,16,24,15,18,33,21,14],
  gal:[24,21,29,31,26,18],eph:[23,22,21,28,20,32],php:[30,30,21,23],
  col:[29,23,25,18],"1th":[10,20,13,18,28],"2th":[12,17,18],
  "1ti":[20,15,16,16,25,21],"2ti":[18,26,17,22],tit:[16,15,15],phm:[25],
  heb:[14,18,19,16,14,20,28,13,28,39,40,29,25],jas:[27,26,18,17,20],
  "1pe":[25,25,22,19,14],"2pe":[21,22,18],
  "1jn":[10,29,24,21,21],"2jn":[13],"3jn":[15],jud:[25],
  rev:[20,29,22,11,14,17,17,13,21,11,19,17,18,20,8,21,18,24,21,15,27,21]
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   2. ì›ë³¸ ë³µêµ¬: 66ê¶Œ ì±… ëª©ë¡
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BOOKS=[
  {id:"gen",name:"ì°½ì„¸ê¸°",abbr:"ì°½",t:"old"},{id:"exo",name:"ì¶œì• êµ½ê¸°",abbr:"ì¶œ",t:"old"},
  {id:"lev",name:"ë ˆìœ„ê¸°",abbr:"ë ˆ",t:"old"},{id:"num",name:"ë¯¼ìˆ˜ê¸°",abbr:"ë¯¼",t:"old"},
  {id:"deu",name:"ì‹ ëª…ê¸°",abbr:"ì‹ ",t:"old"},{id:"jos",name:"ì—¬í˜¸ìˆ˜ì•„",abbr:"ìˆ˜",t:"old"},
  {id:"jdg",name:"ì‚¬ì‚¬ê¸°",abbr:"ì‚¿",t:"old"},{id:"rut",name:"ë£»ê¸°",abbr:"ë£»",t:"old"},
  {id:"1sa",name:"ì‚¬ë¬´ì—˜ìƒ",abbr:"ì‚¼ìƒ",t:"old"},{id:"2sa",name:"ì‚¬ë¬´ì—˜í•˜",abbr:"ì‚¼í•˜",t:"old"},
  {id:"1ki",name:"ì—´ì™•ê¸°ìƒ",abbr:"ì™•ìƒ",t:"old"},{id:"2ki",name:"ì—´ì™•ê¸°í•˜",abbr:"ì™•í•˜",t:"old"},
  {id:"1ch",name:"ì—­ëŒ€ìƒ",abbr:"ëŒ€ìƒ",t:"old"},{id:"2ch",name:"ì—­ëŒ€í•˜",abbr:"ëŒ€í•˜",t:"old"},
  {id:"ezr",name:"ì—ìŠ¤ë¼",abbr:"ìŠ¤",t:"old"},{id:"neh",name:"ëŠí—¤ë¯¸ì•¼",abbr:"ëŠ",t:"old"},
  {id:"est",name:"ì—ìŠ¤ë”",abbr:"ì—",t:"old"},{id:"job",name:"ìš¥ê¸°",abbr:"ìš¥",t:"old"},
  {id:"psa",name:"ì‹œí¸",abbr:"ì‹œ",t:"old"},{id:"pro",name:"ì ì–¸",abbr:"ì ",t:"old"},
  {id:"ecc",name:"ì „ë„ì„œ",abbr:"ì „",t:"old"},{id:"sng",name:"ì•„ê°€",abbr:"ì•„",t:"old"},
  {id:"isa",name:"ì´ì‚¬ì•¼",abbr:"ì‚¬",t:"old"},{id:"jer",name:"ì˜ˆë ˆë¯¸ì•¼",abbr:"ë ˜",t:"old"},
  {id:"lam",name:"ì˜ˆë ˆë¯¸ì•¼ì• ê°€",abbr:"ì• ",t:"old"},{id:"ezk",name:"ì—ìŠ¤ê²”",abbr:"ê²”",t:"old"},
  {id:"dan",name:"ë‹¤ë‹ˆì—˜",abbr:"ë‹¨",t:"old"},{id:"hos",name:"í˜¸ì„¸ì•„",abbr:"í˜¸",t:"old"},
  {id:"jol",name:"ìš”ì—˜",abbr:"ìšœ",t:"old"},{id:"amo",name:"ì•„ëª¨ìŠ¤",abbr:"ì•”",t:"old"},
  {id:"oba",name:"ì˜¤ë°”ëŒœ",abbr:"ì˜µ",t:"old"},{id:"jon",name:"ìš”ë‚˜",abbr:"ìš˜",t:"old"},
  {id:"mic",name:"ë¯¸ê°€",abbr:"ë¯¸",t:"old"},{id:"nah",name:"ë‚˜í›”",abbr:"ë‚˜",t:"old"},
  {id:"hab",name:"í•˜ë°•êµ­",abbr:"í•©",t:"old"},{id:"zep",name:"ìŠ¤ë°”ëƒ",abbr:"ìŠµ",t:"old"},
  {id:"hag",name:"í•™ê°œ",abbr:"í•™",t:"old"},{id:"zec",name:"ìŠ¤ê°€ë´",abbr:"ìŠ¥",t:"old"},
  {id:"mal",name:"ë§ë¼ê¸°",abbr:"ë§",t:"old"},
  {id:"mat",name:"ë§ˆíƒœë³µìŒ",abbr:"ë§ˆ",t:"new"},{id:"mrk",name:"ë§ˆê°€ë³µìŒ",abbr:"ë§‰",t:"new"},
  {id:"luk",name:"ëˆ„ê°€ë³µìŒ",abbr:"ëˆ…",t:"new"},{id:"jhn",name:"ìš”í•œë³µìŒ",abbr:"ìš”",t:"new"},
  {id:"act",name:"ì‚¬ë„í–‰ì „",abbr:"í–‰",t:"new"},{id:"rom",name:"ë¡œë§ˆì„œ",abbr:"ë¡¬",t:"new"},
  {id:"1co",name:"ê³ ë¦°ë„ì „ì„œ",abbr:"ê³ ì „",t:"new"},{id:"2co",name:"ê³ ë¦°ë„í›„ì„œ",abbr:"ê³ í›„",t:"new"},
  {id:"gal",name:"ê°ˆë¼ë””ì•„ì„œ",abbr:"ê°ˆ",t:"new"},{id:"eph",name:"ì—ë² ì†Œì„œ",abbr:"ì—¡",t:"new"},
  {id:"php",name:"ë¹Œë¦½ë³´ì„œ",abbr:"ë¹Œ",t:"new"},{id:"col",name:"ê³¨ë¡œìƒˆì„œ",abbr:"ê³¨",t:"new"},
  {id:"1th",name:"ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ",abbr:"ì‚´ì „",t:"new"},{id:"2th",name:"ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ",abbr:"ì‚´í›„",t:"new"},
  {id:"1ti",name:"ë””ëª¨ë°ì „ì„œ",abbr:"ë”¤ì „",t:"new"},{id:"2ti",name:"ë””ëª¨ë°í›„ì„œ",abbr:"ë”¤í›„",t:"new"},
  {id:"tit",name:"ë””ë„ì„œ",abbr:"ë”›",t:"new"},{id:"phm",name:"ë¹Œë ˆëª¬ì„œ",abbr:"ëª¬",t:"new"},
  {id:"heb",name:"íˆë¸Œë¦¬ì„œ",abbr:"íˆ",t:"new"},{id:"jas",name:"ì•¼ê³ ë³´ì„œ",abbr:"ì•½",t:"new"},
  {id:"1pe",name:"ë² ë“œë¡œì „ì„œ",abbr:"ë²§ì „",t:"new"},{id:"2pe",name:"ë² ë“œë¡œí›„ì„œ",abbr:"ë²§í›„",t:"new"},
  {id:"1jn",name:"ìš”í•œ1ì„œ",abbr:"ìš”ì¼",t:"new"},{id:"2jn",name:"ìš”í•œ2ì„œ",abbr:"ìš”ì´",t:"new"},
  {id:"3jn",name:"ìš”í•œ3ì„œ",abbr:"ìš”ì‚¼",t:"new"},{id:"jud",name:"ìœ ë‹¤ì„œ",abbr:"ìœ ",t:"new"},
  {id:"rev",name:"ìš”í•œê³„ì‹œë¡",abbr:"ê³„",t:"new"}
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   3. ì•± ìƒíƒœ ë° ë·° ê´€ë¦¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const S={
  testament:'old',
  book:null, chapter:null, verse:null,
  cache:{},
  bookmarks:JSON.parse(localStorage.getItem('bm')||'[]'),
  workerUrl: '%%WORKER_URL%%',   // â† ë°°í¬ ì‹œ Cloudflare Worker ì£¼ì†Œë¡œ êµì²´
  history:[],
};

const VIEWS={home:'vHome',chapter:'vChapter',verse:'vVerse',read:'vRead'};

function showView(name, pushHistory=true){
  Object.values(VIEWS).forEach(id=>document.getElementById(id).style.display='none');
  document.getElementById(VIEWS[name]).style.display='block';

  if(pushHistory && S.history[S.history.length-1]!==name) S.history.push(name);

  const hdrTitle=document.getElementById('hdrTitle');
  const hdrAi=document.getElementById('hdrAiBtn');
  const btnBack=document.getElementById('btnBack');

  btnBack.disabled = S.history.length<=1;

  if(name==='home'){
    hdrTitle.textContent='âœ ë§ì”€';
    hdrTitle.className='hdr-title logo-mode';
    hdrAi.style.display='none';
    S.history=['home']; 
    btnBack.disabled=true;
  } else if(name==='chapter'){
    hdrTitle.textContent=S.book.name;
    hdrTitle.className='hdr-title';
    hdrAi.style.display='none';
  } else if(name==='verse'){
    hdrTitle.textContent=`${S.book.name} ${S.chapter}ì¥`;
    hdrTitle.className='hdr-title';
    hdrAi.style.display='none';
  } else if(name==='read'){
    hdrTitle.textContent=`${S.book.name} ${S.chapter}ì¥`;
    hdrTitle.className='hdr-title';
    hdrAi.style.display='flex';
  }
}

function goBack(){
  if(S.history.length<=1) return;
  S.history.pop();
  const prev=S.history[S.history.length-1];
  showView(prev, false);
  if(prev==='chapter') renderChapters();
  if(prev==='verse') renderVerseNums(VC[S.book.id][S.chapter-1]);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   4. ì±… / ì¥ / ì ˆ ë Œë”ë§
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderBooks(){
  const grid=document.getElementById('bookGrid');
  grid.innerHTML=BOOKS.filter(b=>b.t===S.testament).map(b=>`
    <div class="book-card" data-id="${b.id}">
      <span class="book-abbr">${b.abbr}</span>
      <span class="book-name">${b.name}</span>
    </div>`).join('');

  grid.querySelectorAll('.book-card').forEach(card=>{
    card.addEventListener('click',()=>goBook(BOOKS.find(b=>b.id===card.dataset.id)));
  });
}

function goBook(bk){
  S.book=bk;
  document.getElementById('chTitle').textContent=`${bk.name} â€” ì¥ ì„ íƒ`;
  renderChapters();
  showView('chapter');
}

function renderChapters(){
  const total=VC[S.book.id].length;
  document.getElementById('chGrid').innerHTML=
    Array.from({length:total},(_,i)=>`<button class="ch-btn" data-ch="${i+1}">${i+1}</button>`).join('');
  document.getElementById('chGrid').querySelectorAll('.ch-btn').forEach(btn=>{
    btn.addEventListener('click',()=>goChapter(parseInt(btn.dataset.ch)));
  });
}

function goChapter(ch, targetVerse=null){
  S.chapter=ch;
  document.getElementById('vTitle').textContent=`${S.book.name} ${ch}ì¥ â€” ì ˆ ì„ íƒ`;
  const cnt=VC[S.book.id][ch-1];
  if(targetVerse!==null){
    S.verse=targetVerse;
    loadAndRead(ch,targetVerse);
  } else {
    renderVerseNums(cnt);
    showView('verse');
  }
}

function renderVerseNums(count){
  document.getElementById('vGrid').innerHTML=
    Array.from({length:count},(_,i)=>`<button class="v-btn" data-v="${i+1}">${i+1}</button>`).join('');
  document.getElementById('vGrid').querySelectorAll('.v-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{S.verse=parseInt(btn.dataset.v);loadAndRead(S.chapter,S.verse);});
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   5. Cloudflare KV í†µì‹  ë° ë³¸ë¬¸ ë Œë”ë§
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchCh(bookId,ch){
  const key=`${bookId}_${ch}`;
  if(S.cache[key]) return S.cache[key];
  
  // Cloudflare KV Worker í˜¸ì¶œ
  const workerUrl=S.workerUrl;
  if(workerUrl && workerUrl!=='%%WORKER_URL%%'){
    try{
      const r=await fetch(`${workerUrl}/bible?book=${bookId}&chapter=${ch}`);
      if(!r.ok) throw new Error('worker err');
      const data=await r.json();
      if(data.verses && data.verses.length){
        S.cache[key]=data.verses; return data.verses;
      }
    }catch(e){
      console.warn('Worker ë¡œë“œ ì‹¤íŒ¨:', e);
    }
  }

  // í´ë°±: Worker ì—°ê²° ì•ˆ ë  ì‹œ ì„ì‹œ í…ìŠ¤íŠ¸
  const n=VC[bookId][ch-1];
  return Array.from({length:n},(_,i)=>`(${i+1}ì ˆ â€” ë³¸ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. Worker ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.)`);
}

async function loadAndRead(ch, targetVerse){
  S.chapter=ch; S.verse=targetVerse;
  document.getElementById('hdrTitle').textContent=`${S.book.name} ${ch}ì¥`;

  showView('read');
  document.getElementById('versesWrap').innerHTML=
    `<div style="padding:40px;text-align:center;color:var(--text3)">
       <div class="dots"><span></span><span></span><span></span></div>
       <div style="margin-top:14px;font-size:15px">ë§ì”€ ì‚¬ë¬¼í•¨(KV)ì—ì„œ êº¼ë‚´ëŠ” ì¤‘â€¦</div>
     </div>`;
  updateNavBtns();

  const verses=await fetchCh(S.book.id, ch);
  renderVerses(verses, targetVerse);

  setTimeout(()=>{
    const el=document.querySelector(`.verse-row[data-v="${targetVerse}"]`);
    if(el){el.scrollIntoView({behavior:'smooth',block:'center'});applyDim(targetVerse);}
  },80);
}

function isBm(v){return S.bookmarks.some(b=>b.bid===S.book.id&&b.ch===S.chapter&&b.v===v)}

function renderVerses(verses, hl){
  document.getElementById('versesWrap').innerHTML=verses.map((text,i)=>{
    const v=i+1, bm=isBm(v);
    return `<div class="verse-row${v===hl?' hl':''}" data-v="${v}">
      <span class="vn">${v}</span>
      <span class="vt">${text}</span>
      <div class="v-acts">
        <button class="v-act-btn${bm?' bm-on':''}" data-act="bm" data-v="${v}">ğŸ”– ë¶ë§ˆí¬</button>
        <button class="v-act-btn" data-act="ai" data-v="${v}">âœ¨ êµ¬ì ˆ ìš”ì•½</button>
      </div>
    </div>`;
  }).join('');

  document.querySelectorAll('.verse-row').forEach(row=>{
    row.addEventListener('click',e=>{
      const btn=e.target.closest('.v-act-btn');
      if(btn){
        e.stopPropagation();
        const v=parseInt(btn.dataset.v);
        if(btn.dataset.act==='bm') toggleBm(v,btn);
        if(btn.dataset.act==='ai') openAiSheet('verse',null,v);
        return;
      }
      highlightV(parseInt(row.dataset.v));
    });
  });
}

function applyDim(tv){
  const rows=document.querySelectorAll('.verse-row');
  rows.forEach(r=>parseInt(r.dataset.v)!==tv&&r.classList.add('dim'));
  const cancel=()=>{rows.forEach(r=>r.classList.remove('dim'));};
  setTimeout(()=>{
    document.getElementById('versesWrap').addEventListener('scroll',cancel,{once:true});
    window.addEventListener('scroll',cancel,{once:true});
    window.addEventListener('touchmove',cancel,{once:true});
  },500);
}

function highlightV(v){
  document.querySelectorAll('.verse-row').forEach(r=>r.classList.remove('hl','dim'));
  const r=document.querySelector(`.verse-row[data-v="${v}"]`);
  if(r) r.classList.add('hl');
  S.verse=v;
}

function updateNavBtns(){
  const total=VC[S.book.id].length;
  document.getElementById('prevBtn').disabled=S.chapter<=1;
  document.getElementById('nextBtn').disabled=S.chapter>=total;
}

async function changeChapter(delta){
  const newCh=S.chapter+delta;
  const total=VC[S.book.id].length;
  if(newCh<1||newCh>total) return;
  S.chapter=newCh;
  S.verse=1;
  document.getElementById('hdrTitle').textContent=`${S.book.name} ${newCh}ì¥`;
  updateNavBtns();

  document.getElementById('versesWrap').innerHTML=
    `<div style="padding:40px;text-align:center;color:var(--text3)">
       <div class="dots"><span></span><span></span><span></span></div>
     </div>`;
  window.scrollTo(0,0);

  const verses=await fetchCh(S.book.id,newCh);
  renderVerses(verses,1);
  S.history=S.history.filter(v=>v!=='read');
  S.history.push('read');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   6. ë¶ë§ˆí¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleBm(v,btn){
  const idx=S.bookmarks.findIndex(b=>b.bid===S.book.id&&b.ch===S.chapter&&b.v===v);
  if(idx>=0){
    S.bookmarks.splice(idx,1);btn.classList.remove('bm-on');toast('ë¶ë§ˆí¬ ì‚­ì œë¨');
  }else{
    const verses=S.cache[`${S.book.id}_${S.chapter}`]||[];
    S.bookmarks.push({bid:S.book.id,bookName:S.book.name,ch:S.chapter,v,text:verses[v-1]||''});
    btn.classList.add('bm-on');toast('ë¶ë§ˆí¬ ì €ì¥ë¨ ğŸ”–');
  }
  localStorage.setItem('bm',JSON.stringify(S.bookmarks));
}

function renderBm(){
  const list=document.getElementById('bmList');
  if(!S.bookmarks.length){
    list.innerHTML=`<div class="empty-box"><div class="empty-ico">ğŸ”–</div>ì €ì¥ëœ ë¶ë§ˆí¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;return;
  }
  list.innerHTML=S.bookmarks.map((b,i)=>`
    <div class="bm-item" data-i="${i}">
      <div class="bm-ico">ğŸ”–</div>
      <div style="flex:1;min-width:0">
        <div class="bm-ref">${b.bookName} ${b.ch}:${b.v}</div>
        <div class="bm-txt">${b.text}</div>
      </div>
      <button class="bm-del" data-i="${i}">âœ•</button>
    </div>`).join('');
  list.querySelectorAll('.bm-item').forEach(item=>{
    item.addEventListener('click',e=>{
      if(e.target.classList.contains('bm-del')){
        S.bookmarks.splice(+e.target.dataset.i,1);
        localStorage.setItem('bm',JSON.stringify(S.bookmarks));renderBm();return;
      }
      const bm=S.bookmarks[+item.dataset.i];
      const bk=BOOKS.find(b=>b.id===bm.bid);
      if(bk){goBook(bk);goChapter(bm.ch,bm.v);switchTab('bible');}
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   7. AI í†µì‹  ë¡œì§ (ì‚¬ë¬¼í•¨ ì—°ë™ìš©)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function openAiSheet(type,bookObj=null,vNum=null){
  const sheet=document.getElementById('aiSheet');
  const ov=document.getElementById('overlay');
  const title=document.getElementById('shTitle');
  const badge=document.getElementById('shBadge');
  const body=document.getElementById('shBody');

  let prompt='';
  if(type==='book'){
    title.textContent=`${bookObj.name} ì´ì•¼ê¸°`;
    prompt=`${bookObj.name} ì „ì²´ ìŠ¤í† ë¦¬ë¥¼ ì§§ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ìš”ì•½í•´ì¤˜.`;
  }else if(type==='chapter'){
    title.textContent=`${S.book.name} ${S.chapter}ì¥`;
    prompt=`${S.book.name} ${S.chapter}ì¥ì˜ ìƒí™©ì„ ìš”ì•½í•´ì¤˜.`;
  }else if(type==='verse'){
    const verses=S.cache[`${S.book.id}_${S.chapter}`]||[];
    const text=verses[vNum-1]||'';
    title.textContent=`${S.book.name} ${S.chapter}:${vNum}`;
    prompt=`"${text}" ì´ êµ¬ì ˆì˜ ìƒí™©ì  ë°°ê²½ê³¼ í•µì‹¬ ì˜ë¯¸ë¥¼ ì´í•´í•˜ê¸° ì‰½ê²Œ ìš”ì•½í•´ì¤˜.`;
  }

  body.innerHTML=`<div style="display:flex;align-items:center;gap:10px;color:var(--text3);padding:8px 0"><div class="dots"><span></span><span></span><span></span></div> ìƒí™© ìš”ì•½ ì¤‘ì…ë‹ˆë‹¤â€¦</div>`;
  sheet.classList.add('on');ov.classList.add('on');

  const result=await callWorkerAI(prompt);
  body.innerHTML=result.replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
}

async function callWorkerAI(prompt){
  const url=S.workerUrl;
  if(!url||url==='%%WORKER_URL%%'){
    return 'âš ï¸ <strong>Worker URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</strong><br><br>ì½”ë“œ ì•ˆì˜ <code>%%WORKER_URL%%</code> ë¶€ë¶„ì„ í´ë¼ìš°ë“œí”Œë ˆì–´ ì£¼ì†Œë¡œ êµì²´í•´ì£¼ì„¸ìš”.';
  }
  try{
    const r=await fetch(`${url}/ai`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({prompt})
    });
    const d=await r.json();
    return d.text||'ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
  }catch(e){
    return `âŒ ì—°ê²° ì‹¤íŒ¨: Workerê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.`;
  }
}

function closeSheet(){
  document.getElementById('aiSheet').classList.remove('on');
  document.getElementById('overlay').classList.remove('on');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   8. íƒ­ ì „í™˜ ë° ì´ˆê¸°í™”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchTab(tab){
  document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('on',b.dataset.tab===tab));
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
  document.getElementById(tab+'-page').classList.add('on');
  if(tab==='bookmarks') renderBm();
}

function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('on');
  setTimeout(()=>t.classList.remove('on'),2200);
}

document.addEventListener('DOMContentLoaded',()=>{
  S.history=['home'];
  renderBooks();

  document.getElementById('btnHome').addEventListener('click',()=>{
    switchTab('bible');showView('home');
  });
  document.getElementById('btnBack').addEventListener('click',goBack);

  document.querySelectorAll('.t-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.t-btn').forEach(b=>b.classList.remove('on'));
      btn.classList.add('on');S.testament=btn.dataset.t;renderBooks();
    });
  });

  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click',()=>switchTab(btn.dataset.tab));
  });
  
  // ë¶ë§ˆí¬ íƒ­ìœ¼ë¡œ ì´ë™
  document.getElementById('btnBm').addEventListener('click',()=>switchTab('bookmarks'));

  // AI ìš”ì•½ ë²„íŠ¼ ì—°ë™
  document.getElementById('bookAiBtn').addEventListener('click',()=>openAiSheet('book',S.book));
  document.getElementById('chapAiBtn').addEventListener('click',()=>openAiSheet('chapter'));
  document.getElementById('hdrAiBtn').addEventListener('click',()=>openAiSheet('chapter'));

  document.getElementById('prevBtn').addEventListener('click',()=>changeChapter(-1));
  document.getElementById('nextBtn').addEventListener('click',()=>changeChapter(1));

  document.getElementById('shClose').addEventListener('click',closeSheet);
  document.getElementById('overlay').addEventListener('click',closeSheet);

  document.getElementById('clearBmBtn').addEventListener('click',()=>{
    if(confirm('ë¶ë§ˆí¬ë¥¼ ì „ë¶€ ì‚­ì œí• ê¹Œìš”?')){
      S.bookmarks=[];localStorage.removeItem('bm');toast('ë¶ë§ˆí¬ ì „ì²´ ì‚­ì œë¨');
      renderBm();
    }
  });
});
</script>
</body>
</html>
