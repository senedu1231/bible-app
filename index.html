<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë§ì”€ â€” ì„±ê²½ AI í•´ì„¤</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Serif+KR:wght@300;400;600;900&family=Noto+Sans+KR:wght@300;400;700;900&display=swap" rel="stylesheet">
<style>
/* ========== ë‹¤í¬ í…Œë§ˆ ========== */
:root, [data-theme="dark"] {
  --bg: #0f0e0c;
  --bg2: #1a1814;
  --surface: #211f1b;
  --surface2: #2a2720;
  --gold: #e8b84b;
  --gold2: #f5d080;
  --gold-dim: rgba(232,184,75,0.1);
  --gold-glow: rgba(232,184,75,0.22);
  --text: #f0ead8;
  --text2: #9b9080;
  --text3: #5a5248;
  --border: rgba(232,184,75,0.2);
  --border2: rgba(255,255,255,0.07);
  --red: #e84b4b;
  --verse-hl: rgba(232,184,75,0.08);
  --shadow: 0 4px 24px rgba(0,0,0,0.55);
  --progress-bg: rgba(255,255,255,0.06);
  --hdr-bg: rgba(15,14,12,0.94);
  --sheet-bg: #1a1814;
}
/* ========== ë¼ì´íŠ¸ í…Œë§ˆ ========== */
[data-theme="light"] {
  --bg: #faf8f3;
  --bg2: #f3ede2;
  --surface: #ffffff;
  --surface2: #f5f0e8;
  --gold: #a06000;
  --gold2: #c07820;
  --gold-dim: rgba(160,96,0,0.07);
  --gold-glow: rgba(160,96,0,0.14);
  --text: #1e1810;
  --text2: #5e4e32;
  --text3: #a0896a;
  --border: rgba(160,96,0,0.2);
  --border2: rgba(0,0,0,0.07);
  --red: #c0392b;
  --verse-hl: rgba(160,96,0,0.06);
  --shadow: 0 4px 20px rgba(80,55,20,0.12);
  --progress-bg: rgba(0,0,0,0.07);
  --hdr-bg: rgba(250,248,243,0.96);
  --sheet-bg: #faf8f3;
}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body {
  font-family: 'Noto Sans KR', sans-serif;
  background: var(--bg); color: var(--text);
  min-height: 100vh; overflow-x: hidden;
  transition: background 0.3s, color 0.3s;
}

/* ========== í—¤ë” ========== */
.hdr {
  position: sticky; top: 0; z-index: 200;
  background: var(--hdr-bg);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border2);
  height: 58px; display: flex; align-items: center; padding: 0 12px; gap: 7px;
}
.hdr-btn {
  width: 38px; height: 38px; border-radius: 10px;
  border: 1px solid var(--border2); background: var(--surface);
  color: var(--text2); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; flex-shrink: 0; transition: all 0.15s;
}
.hdr-btn:active { transform: scale(0.88); }
.hdr-logo {
  flex: 1; display: flex; align-items: center; gap: 6px; justify-content: center;
}
.hdr-logo-text {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 22px; letter-spacing: 3px;
}
[data-theme="dark"] .hdr-logo-text {
  background: linear-gradient(135deg, #e8b84b 0%, #f5d080 60%, #fffbe0 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
[data-theme="light"] .hdr-logo-text {
  background: linear-gradient(135deg, #6b3a00, #a06000, #d08010);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.hdr-title-text {
  flex: 1; text-align: center;
  font-family: 'Noto Serif KR', serif;
  font-size: 15px; font-weight: 600; color: var(--text);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.hdr-ai-btn {
  display: none; align-items: center; gap: 4px;
  padding: 7px 10px; border-radius: 20px;
  background: var(--gold-dim); border: 1px solid var(--border);
  color: var(--gold); font-size: 11px; font-weight: 700;
  cursor: pointer; white-space: nowrap; transition: all 0.15s;
}
.hdr-ai-btn:active { transform: scale(0.92); }

/* ========== í…Œë§ˆ í† ê¸€ ìŠ¤ìœ„ì¹˜ ========== */
.toggle-track {
  width: 46px; height: 26px; border-radius: 13px;
  background: var(--surface2); border: 1px solid var(--border2);
  position: relative; cursor: pointer; transition: all 0.3s; flex-shrink: 0;
}
.toggle-knob {
  width: 20px; height: 20px; border-radius: 50%;
  background: var(--gold); box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  position: absolute; top: 2px; left: 3px;
  transition: transform 0.3s cubic-bezier(.34,1.56,.64,1);
  display: flex; align-items: center; justify-content: center; font-size: 11px;
}
[data-theme="light"] .toggle-knob { transform: translateX(20px); }

/* ========== íƒ­ë°” ========== */
.tabbar {
  display: flex; background: var(--bg2);
  border-bottom: 1px solid var(--border2);
  padding: 0 16px;
  position: sticky; top: 58px; z-index: 190;
}
.tab {
  flex: 1; padding: 13px 0 11px;
  border: none; background: none; color: var(--text3);
  cursor: pointer; font-size: 13px; font-weight: 700;
  border-bottom: 2.5px solid transparent; transition: all 0.2s;
}
.tab.on { color: var(--gold); border-bottom-color: var(--gold); }

/* ========== í˜ì´ì§€ ========== */
.page { display: none; }
.page.on { display: block; }

/* ========== í™ˆ íˆì–´ë¡œ ========== */
.home-hero {
  padding: 36px 20px 28px; text-align: center;
  border-bottom: 1px solid var(--border2); position: relative; overflow: hidden;
}
.home-hero::before {
  content: 'âœ'; position: absolute; font-size: 220px; font-family: serif;
  color: var(--gold); opacity: 0.04;
  top: 50%; left: 50%; transform: translate(-50%,-50%); pointer-events: none;
}
.home-hero-badge {
  display: inline-block; padding: 4px 12px; border-radius: 20px;
  background: var(--gold-dim); border: 1px solid var(--border);
  color: var(--gold); font-size: 10px; font-weight: 700;
  letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 12px;
}
.home-hero-title {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 52px; line-height: 1; margin-bottom: 8px; letter-spacing: 4px;
}
[data-theme="dark"] .home-hero-title {
  background: linear-gradient(160deg, #fff6d0 0%, #e8b84b 50%, #c8870a 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
[data-theme="light"] .home-hero-title {
  background: linear-gradient(160deg, #5a2e00 0%, #a06000 50%, #d08010 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.home-hero-sub { font-size: 13px; color: var(--text3); }

/* ========== ì˜¤ëŠ˜ì˜ ë§ì”€ ========== */
.daily-banner {
  margin: 14px 14px 0; padding: 18px 20px;
  background: var(--gold-dim); border: 1px solid var(--border); border-radius: 16px;
  position: relative; overflow: hidden;
}
.daily-banner::before {
  content: '"'; position: absolute; top: -10px; left: 12px;
  font-size: 80px; font-family: serif;
  color: var(--gold); opacity: 0.14; line-height: 1; pointer-events: none;
}
.daily-label { font-size: 10px; font-weight: 700; color: var(--gold); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; }
.daily-text { font-family: 'Noto Serif KR', serif; font-size: 15px; line-height: 1.85; color: var(--text); word-break: keep-all; }
.daily-ref { font-size: 12px; color: var(--text3); margin-top: 8px; text-align: right; }

/* ========== êµ¬/ì‹ ì•½ ë²„íŠ¼ ========== */
.t-btn-wrap { display: flex; gap: 8px; padding: 14px 14px 4px; }
.t-btn {
  flex: 1; padding: 13px; border-radius: 14px;
  background: var(--surface); border: 1px solid var(--border2);
  color: var(--text3); font-size: 14px; font-weight: 700;
  cursor: pointer; transition: all 0.2s;
}
.t-btn.on {
  background: var(--surface2); border-color: var(--gold); color: var(--gold);
  box-shadow: 0 0 16px var(--gold-glow);
}
.t-btn:active { transform: scale(0.95); }

/* ========== ì±… ê·¸ë¦¬ë“œ ========== */
.book-grid {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: 8px; padding: 10px 12px 90px;
}
.book-card {
  background: var(--surface); border: 1px solid var(--border2);
  border-radius: 14px; padding: 14px 8px 12px;
  cursor: pointer; text-align: center; transition: all 0.15s;
}
.book-card:active { transform: scale(0.95); background: var(--surface2); }
.book-card.last-visited {
  border-color: var(--gold); background: var(--surface2);
  box-shadow: 0 0 14px var(--gold-glow);
}
.book-card-name {
  font-family: 'Noto Serif KR', serif;
  font-size: 14px; font-weight: 700; color: var(--gold); margin-bottom: 3px;
}
.book-card-sub { font-size: 10px; color: var(--text3); }

/* ========== ì±… ìš”ì•½ ë²„íŠ¼ ========== */
.book-summary-btn {
  width: 100%; padding: 15px 20px; border-radius: 14px;
  background: var(--gold-dim); border: 1px solid var(--border);
  color: var(--gold); font-size: 14px; font-weight: 700; cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 8px;
  transition: all 0.15s;
}
.book-summary-btn:active { transform: scale(0.97); }

/* ========== ì¥ ê·¸ë¦¬ë“œ ========== */
.ch-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
  gap: 8px; padding: 12px 14px 90px;
}
.ch-btn {
  aspect-ratio: 1; border-radius: 12px;
  background: var(--surface); border: 1px solid var(--border2);
  color: var(--text2); font-size: 14px; font-weight: 700;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: all 0.15s;
}
.ch-btn:active { transform: scale(0.88); }
.ch-btn.last-visited {
  border-color: var(--gold); background: var(--gold-dim); color: var(--gold);
  box-shadow: 0 0 10px var(--gold-glow);
}

/* ========== ì§„í–‰ ìƒí™© ë°” ========== */
.progress-bar-wrap {
  position: sticky; top: 114px; z-index: 150;
  background: var(--bg2); padding: 10px 16px;
  border-bottom: 1px solid var(--border2);
  display: flex; align-items: center; gap: 10px;
}
.progress-info { font-size: 11px; font-weight: 700; color: var(--text3); white-space: nowrap; }
.progress-info b { color: var(--gold); font-weight: 700; }
.progress-track {
  flex: 1; height: 5px; border-radius: 3px;
  background: var(--progress-bg); overflow: hidden;
}
.progress-fill {
  height: 100%; border-radius: 3px;
  background: linear-gradient(90deg, var(--gold), var(--gold2));
  transition: width 0.4s cubic-bezier(.4,0,.2,1);
}
.progress-pct { font-size: 11px; font-weight: 700; color: var(--gold); white-space: nowrap; }

/* ========== ë³¸ë¬¸ ========== */
.verses-wrap { padding: 14px 14px 100px; }
.verse-row {
  display: flex; gap: 12px; padding: 13px 10px;
  border-radius: 12px; margin-bottom: 2px; cursor: pointer;
  transition: background 0.15s; border: 1px solid transparent;
}
.verse-row:active { background: var(--surface); }
.verse-row.hl { background: var(--verse-hl); border-color: var(--border); }
.vn {
  font-size: 11px; color: var(--gold); font-weight: 700;
  min-width: 20px; text-align: right; padding-top: 5px; opacity: 0.6;
}
.vt {
  font-family: 'Noto Serif KR', serif;
  font-size: 17px; line-height: 1.95; color: var(--text); word-break: keep-all; flex: 1;
}

/* ========== í”Œë¡œíŒ… ì ˆ ì•¡ì…˜ (ìš°í•˜ë‹¨) ========== */
.float-label {
  position: fixed; bottom: 208px; right: 16px; z-index: 160;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 10px; padding: 5px 10px;
  font-size: 11px; font-weight: 700; color: var(--gold);
  opacity: 0; pointer-events: none;
  transform: translateY(6px);
  transition: all 0.2s;
}
.float-label.show { opacity: 1; transform: translateY(0); }

.floating-actions {
  position: fixed; bottom: 78px; right: 16px; z-index: 160;
  display: flex; flex-direction: column; gap: 8px;
  opacity: 0; pointer-events: none;
  transform: translateY(12px) scale(0.95);
  transition: all 0.22s cubic-bezier(.34,1.4,.64,1);
}
.floating-actions.show {
  opacity: 1; pointer-events: all; transform: translateY(0) scale(1);
}
.float-btn {
  display: flex; align-items: center; gap: 8px;
  padding: 11px 16px; border-radius: 22px;
  border: 1px solid var(--border);
  font-size: 13px; font-weight: 700; cursor: pointer;
  white-space: nowrap; transition: all 0.13s;
  box-shadow: var(--shadow); backdrop-filter: blur(14px);
}
.float-btn:active { transform: scale(0.93); }
.float-btn-bm {
  background: var(--surface2); color: var(--text2);
}
.float-btn-ai {
  background: var(--gold); color: #160f00;
  border-color: var(--gold);
  box-shadow: 0 4px 18px var(--gold-glow);
}
/* ë‹«ê¸° ë²„íŠ¼ */
.float-btn-close {
  background: var(--surface); color: var(--text3);
  border-color: var(--border2);
  font-size: 12px; justify-content: center;
  padding: 8px;
}

/* ========== í•˜ë‹¨ ì´ì „/ë‹¤ìŒ ì¥ ========== */
.ch-nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  display: flex; gap: 10px; padding: 10px 14px 14px;
  background: var(--hdr-bg); border-top: 1px solid var(--border2);
  backdrop-filter: blur(20px); z-index: 100;
}
.ch-nav-btn {
  flex: 1; padding: 13px; border-radius: 12px;
  background: var(--surface); border: 1px solid var(--border2);
  color: var(--text2); font-weight: 700; font-size: 14px;
  cursor: pointer; transition: all 0.15s;
}
.ch-nav-btn:active { transform: scale(0.96); background: var(--surface2); }

/* ========== ë¶ë§ˆí¬ ========== */
.bm-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.bm-clear-btn {
  padding: 7px 14px; border-radius: 10px;
  background: rgba(232,75,75,0.1); border: 1px solid rgba(232,75,75,0.3);
  color: var(--red); font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.15s;
}
.bm-clear-btn:active { transform: scale(0.93); }
.bm-list { display: flex; flex-direction: column; gap: 10px; padding-bottom: 80px; }
.bm-card {
  background: var(--surface); border: 1px solid var(--border2);
  border-radius: 14px; padding: 16px; display: flex; flex-direction: column; gap: 10px; transition: all 0.15s;
}
.bm-card:active { transform: scale(0.98); }
.bm-top { display: flex; justify-content: space-between; align-items: flex-start; }
.bm-title { font-weight: 700; color: var(--gold); font-size: 13px; cursor: pointer; }
.bm-del-btn { background: none; border: none; color: var(--text3); cursor: pointer; font-size: 16px; padding: 2px 4px; }
.bm-empty { text-align: center; padding: 80px 20px; color: var(--text3); font-size: 14px; line-height: 1.9; }

/* ========== AI ì‹œíŠ¸ ========== */
.overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.55);
  backdrop-filter: blur(4px); z-index: 300; display: none;
}
.ai-sheet {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 310;
  background: var(--sheet-bg);
  border-radius: 26px 26px 0 0; border-top: 1px solid var(--border);
  transform: translateY(100%); transition: transform 0.35s cubic-bezier(.32,.72,0,1);
  max-height: 78vh; display: flex; flex-direction: column;
}
.ai-sheet.on { transform: translateY(0); }
.ai-sheet-handle { width: 40px; height: 4px; background: var(--border2); border-radius: 4px; margin: 14px auto 0; }
.ai-sheet-header {
  padding: 14px 18px 12px; border-bottom: 1px solid var(--border2);
  display: flex; align-items: center; gap: 10px;
}
.ai-icon { width: 34px; height: 34px; border-radius: 10px; background: var(--gold-dim); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 15px; }
.ai-title { flex: 1; font-family: 'Noto Serif KR', serif; font-size: 15px; font-weight: 600; color: var(--text); }
.ai-close { width: 28px; height: 28px; border-radius: 8px; background: var(--surface2); border: none; color: var(--text3); cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; }
.ai-body { padding: 20px; overflow-y: auto; flex: 1; }
.ai-content { font-size: 16px; line-height: 1.95; color: var(--text2); word-break: keep-all; }
.ai-content strong { color: var(--gold); font-weight: 700; }

/* íƒ€ì´í•‘ ë„íŠ¸ */
.typing-dot { display: inline-flex; gap: 5px; align-items: center; padding: 12px 0; }
.typing-dot span { width: 7px; height: 7px; border-radius: 50%; background: var(--gold); animation: pulse 1.2s ease-in-out infinite; }
.typing-dot span:nth-child(2) { animation-delay: 0.2s; }
.typing-dot span:nth-child(3) { animation-delay: 0.4s; }
@keyframes pulse {
  0%,80%,100% { opacity: 0.2; transform: scale(0.8); }
  40% { opacity: 1; transform: scale(1.1); }
}

/* verse ë“±ì¥ ì• ë‹ˆ */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
.verse-row { animation: fadeInUp 0.25s ease both; }
</style>
</head>
<body>

<div class="hdr">
  <button class="hdr-btn" onclick="goHome()">âŒ‚</button>
  <button class="hdr-btn" id="btnBack" onclick="goBack()" disabled>â†</button>
  <div class="hdr-logo" id="hdrLogo">
    <span style="font-size:13px;color:var(--gold);opacity:0.7">âœ</span>
    <span class="hdr-logo-text">ë§ì”€</span>
  </div>
  <div class="hdr-title-text" id="hdrTitle" style="display:none"></div>
  <button class="hdr-ai-btn" id="hdrAiBtn" onclick="openChapterAi()">âœ¨ ì¥ ìš”ì•½</button>
  <div class="toggle-track" onclick="toggleTheme()" title="ë°ê¸° ì „í™˜">
    <div class="toggle-knob" id="toggleKnob"><span id="toggleIcon">ğŸŒ™</span></div>
  </div>
  <button class="hdr-btn" onclick="switchTab('bookmarks')">ğŸ”–</button>
</div>

<div class="tabbar">
  <button class="tab on" id="tab-bible" onclick="switchTab('bible')">ì„±ê²½ ì½ê¸°</button>
  <button class="tab" id="tab-bookmarks" onclick="switchTab('bookmarks')">ë‚´ ë¶ë§ˆí¬</button>
</div>

<!-- í”Œë¡œíŒ… ì•¡ì…˜ (ì ˆ ì„ íƒ ì‹œ ìš°í•˜ë‹¨) -->
<div class="float-label" id="floatLabel"></div>
<div class="floating-actions" id="floatingActions">
  <button class="float-btn float-btn-bm" onclick="floatBookmark()">ğŸ”– ë¶ë§ˆí¬ ì €ì¥</button>
  <button class="float-btn float-btn-ai" onclick="floatExplain()">âœ¨ AI í•´ì„¤ ë³´ê¸°</button>
  <button class="float-btn float-btn-close" onclick="hideFloating()">âœ• ë‹«ê¸°</button>
</div>

<!-- ì„±ê²½ í˜ì´ì§€ -->
<div id="bible-page" class="page on">
  <div id="vHome">
    <div class="home-hero">
      <div class="home-hero-badge">ê°œì—­í•œê¸€ KRV</div>
      <div class="home-hero-title">ë§ì”€</div>
      <div class="home-hero-sub">ì„±ê²½, ì´ì œ ì‰½ê²Œ ì½ì ğŸ“–</div>
    </div>
    <div class="daily-banner" id="dailyBanner" style="display:none">
      <div class="daily-label">âœ¨ ì˜¤ëŠ˜ì˜ ë§ì”€</div>
      <div class="daily-text" id="dailyText"></div>
      <div class="daily-ref" id="dailyRef"></div>
    </div>
    <div class="t-btn-wrap">
      <button class="t-btn on" id="t-old" onclick="setT('old')">êµ¬ì•½ 39ê¶Œ</button>
      <button class="t-btn" id="t-new" onclick="setT('new')">ì‹ ì•½ 27ê¶Œ</button>
    </div>
    <div class="book-grid" id="bookGrid"></div>
  </div>

  <div id="vChapter" style="display:none">
    <div id="bkSummaryWrap" style="padding:14px 14px 0"></div>
    <div class="ch-grid" id="chGrid"></div>
  </div>

  <div id="vRead" style="display:none">
    <div class="progress-bar-wrap">
      <div class="progress-info" id="progressInfo"></div>
      <div class="progress-track"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
      <div class="progress-pct" id="progressPct"></div>
    </div>
    <div class="verses-wrap" id="versesWrap"></div>
    <div class="ch-nav">
      <button class="ch-nav-btn" onclick="changeCh(-1)">â† ì´ì „ ì¥</button>
      <button class="ch-nav-btn" onclick="changeCh(1)">ë‹¤ìŒ ì¥ â†’</button>
    </div>
  </div>
</div>

<!-- ë¶ë§ˆí¬ í˜ì´ì§€ -->
<div id="bookmarks-page" class="page">
  <div id="bmWrap" style="padding:16px"></div>
</div>

<!-- AI ì‹œíŠ¸ -->
<div class="overlay" id="overlay" onclick="closeAi()"></div>
<div class="ai-sheet" id="aiSheet">
  <div class="ai-sheet-handle"></div>
  <div class="ai-sheet-header">
    <div class="ai-icon">âœ¨</div>
    <div class="ai-title" id="shTitle">AI í•´ì„¤</div>
    <button class="ai-close" onclick="closeAi()">âœ•</button>
  </div>
  <div class="ai-body">
    <div class="ai-content" id="shBody">
      <div class="typing-dot"><span></span><span></span><span></span></div>
    </div>
  </div>
</div>

<script>
const WORKER_URL = 'https://bible-ai-worker.hdh1231.workers.dev';

const BOOKS=[
  {id:"gen",name:"ì°½ì„¸ê¸°",t:"old",c:50},{id:"exo",name:"ì¶œì• êµ½ê¸°",t:"old",c:40},{id:"lev",name:"ë ˆìœ„ê¸°",t:"old",c:27},{id:"num",name:"ë¯¼ìˆ˜ê¸°",t:"old",c:36},{id:"deu",name:"ì‹ ëª…ê¸°",t:"old",c:34},{id:"jos",name:"ì—¬í˜¸ìˆ˜ì•„",t:"old",c:24},{id:"jdg",name:"ì‚¬ì‚¬ê¸°",t:"old",c:21},{id:"rut",name:"ë£»ê¸°",t:"old",c:4},{id:"1sa",name:"ì‚¬ë¬´ì—˜ìƒ",t:"old",c:31},{id:"2sa",name:"ì‚¬ë¬´ì—˜í•˜",t:"old",c:24},{id:"1ki",name:"ì—´ì™•ê¸°ìƒ",t:"old",c:22},{id:"2ki",name:"ì—´ì™•ê¸°í•˜",t:"old",c:25},{id:"1ch",name:"ì—­ëŒ€ìƒ",t:"old",c:29},{id:"2ch",name:"ì—­ëŒ€í•˜",t:"old",c:36},{id:"ezr",name:"ì—ìŠ¤ë¼",t:"old",c:10},{id:"neh",name:"ëŠí—¤ë¯¸ì•¼",t:"old",c:13},{id:"est",name:"ì—ìŠ¤ë”",t:"old",c:10},{id:"job",name:"ìš¥ê¸°",t:"old",c:42},{id:"psa",name:"ì‹œí¸",t:"old",c:150},{id:"pro",name:"ì ì–¸",t:"old",c:31},{id:"ecc",name:"ì „ë„ì„œ",t:"old",c:12},{id:"sng",name:"ì•„ê°€",t:"old",c:8},{id:"isa",name:"ì´ì‚¬ì•¼",t:"old",c:66},{id:"jer",name:"ì˜ˆë ˆë¯¸ì•¼",t:"old",c:52},{id:"lam",name:"ì˜ˆë ˆë¯¸ì•¼ì• ê°€",t:"old",c:5},{id:"ezk",name:"ì—ìŠ¤ê²”",t:"old",c:48},{id:"dan",name:"ë‹¤ë‹ˆì—˜",t:"old",c:12},{id:"hos",name:"í˜¸ì„¸ì•„",t:"old",c:14},{id:"jol",name:"ìš”ì—˜",t:"old",c:3},{id:"amo",name:"ì•„ëª¨ìŠ¤",t:"old",c:9},{id:"oba",name:"ì˜¤ë°”ëŒœ",t:"old",c:1},{id:"jon",name:"ìš”ë‚˜",t:"old",c:4},{id:"mic",name:"ë¯¸ê°€",t:"old",c:7},{id:"nah",name:"ë‚˜í›”",t:"old",c:3},{id:"hab",name:"í•˜ë°•êµ­",t:"old",c:3},{id:"zep",name:"ìŠ¤ë°”ëƒ",t:"old",c:3},{id:"hag",name:"í•™ê°œ",t:"old",c:2},{id:"zec",name:"ìŠ¤ê°€ë´",t:"old",c:14},{id:"mal",name:"ë§ë¼ê¸°",t:"old",c:4},
  {id:"mat",name:"ë§ˆíƒœë³µìŒ",t:"new",c:28},{id:"mrk",name:"ë§ˆê°€ë³µìŒ",t:"new",c:16},{id:"luk",name:"ëˆ„ê°€ë³µìŒ",t:"new",c:24},{id:"jhn",name:"ìš”í•œë³µìŒ",t:"new",c:21},{id:"act",name:"ì‚¬ë„í–‰ì „",t:"new",c:28},{id:"rom",name:"ë¡œë§ˆì„œ",t:"new",c:16},{id:"1co",name:"ê³ ë¦°ë„ì „ì„œ",t:"new",c:16},{id:"2co",name:"ê³ ë¦°ë„í›„ì„œ",t:"new",c:13},{id:"gal",name:"ê°ˆë¼ë””ì•„ì„œ",t:"new",c:6},{id:"eph",name:"ì—ë² ì†Œì„œ",t:"new",c:6},{id:"php",name:"ë¹Œë¦½ë³´ì„œ",t:"new",c:4},{id:"col",name:"ê³¨ë¡œìƒˆì„œ",t:"new",c:4},{id:"1th",name:"ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ",t:"new",c:5},{id:"2th",name:"ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ",t:"new",c:3},{id:"1ti",name:"ë””ëª¨ë°ì „ì„œ",t:"new",c:6},{id:"2ti",name:"ë””ëª¨ë°í›„ì„œ",t:"new",c:4},{id:"tit",name:"ë””ë„ì„œ",t:"new",c:3},{id:"phm",name:"ë¹Œë ˆëª¬ì„œ",t:"new",c:1},{id:"heb",name:"íˆë¸Œë¦¬ì„œ",t:"new",c:13},{id:"jas",name:"ì•¼ê³ ë³´ì„œ",t:"new",c:5},{id:"1pe",name:"ë² ë“œë¡œì „ì„œ",t:"new",c:5},{id:"2pe",name:"ë² ë“œë¡œí›„ì„œ",t:"new",c:3},{id:"1jn",name:"ìš”í•œ1ì„œ",t:"new",c:5},{id:"2jn",name:"ìš”í•œ2ì„œ",t:"new",c:1},{id:"3jn",name:"ìš”í•œ3ì„œ",t:"new",c:1},{id:"jud",name:"ìœ ë‹¤ì„œ",t:"new",c:1},{id:"rev",name:"ìš”í•œê³„ì‹œë¡",t:"new",c:22}
];

const DAILY = [
  {text:"ë„ˆëŠ” ë§ˆìŒì„ ë‹¤í•˜ê³  ëœ»ì„ ë‹¤í•˜ê³  í˜ì„ ë‹¤í•˜ì—¬ ë„¤ í•˜ë‚˜ë‹˜ ì—¬í˜¸ì™€ë¥¼ ì‚¬ë‘í•˜ë¼", ref:"ì‹ ëª…ê¸° 6:5"},
  {text:"ë‚´ê°€ ì„¸ìƒ ëë‚ ê¹Œì§€ ë„ˆí¬ì™€ í•­ìƒ í•¨ê»˜ ìˆìœ¼ë¦¬ë¼", ref:"ë§ˆíƒœë³µìŒ 28:20"},
  {text:"ì—¬í˜¸ì™€ëŠ” ë‚˜ì˜ ëª©ìì‹œë‹ˆ ë‚´ê²Œ ë¶€ì¡±í•¨ì´ ì—†ìœ¼ë¦¬ë¡œë‹¤", ref:"ì‹œí¸ 23:1"},
  {text:"ë„ˆí¬ëŠ” ë¨¼ì € ê·¸ì˜ ë‚˜ë¼ì™€ ê·¸ì˜ ì˜ë¥¼ êµ¬í•˜ë¼ ê·¸ë¦¬í•˜ë©´ ì´ ëª¨ë“  ê²ƒì„ ë„ˆí¬ì—ê²Œ ë”í•˜ì‹œë¦¬ë¼", ref:"ë§ˆíƒœë³µìŒ 6:33"},
  {text:"ë‚´ê°€ ì£¼ê»˜ ê°ì‚¬í•¨ì€ ë‚˜ë¥¼ ì§€ìœ¼ì‹¬ì´ ì‹ ë¬˜ë§‰ì¸¡í•˜ì‹¬ì´ë¼", ref:"ì‹œí¸ 139:14"},
  {text:"ì‚¬ë‘ì€ ì˜¤ë˜ ì°¸ê³  ì‚¬ë‘ì€ ì˜¨ìœ í•˜ë©° íˆ¬ê¸°í•˜ëŠ” ìê°€ ë˜ì§€ ì•„ë‹ˆí•˜ë©°", ref:"ê³ ë¦°ë„ì „ì„œ 13:4"},
  {text:"ë„ˆí¬ê°€ ë‚´ ì•ˆì— ê±°í•˜ê³  ë‚´ ë§ì´ ë„ˆí¬ ì•ˆì— ê±°í•˜ë©´ ë¬´ì—‡ì´ë“ ì§€ ì›í•˜ëŠ” ëŒ€ë¡œ êµ¬í•˜ë¼", ref:"ìš”í•œë³µìŒ 15:7"},
];

let S = { view:'home', t:'old', bk:null, ch:1, hist:['home'], cache:{} };
let selectedVerseIdx = -1;
let currentTheme = localStorage.getItem('bible_theme') || 'dark';

/* ===== í…Œë§ˆ ===== */
function applyTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  document.getElementById('toggleIcon').innerText = t === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
  localStorage.setItem('bible_theme', t);
  currentTheme = t;
}
function toggleTheme() { applyTheme(currentTheme === 'dark' ? 'light' : 'dark'); }

/* ===== íƒ­ ===== */
function switchTab(t) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(b => b.classList.remove('on'));
  document.getElementById(t+'-page').classList.add('on');
  document.getElementById('tab-'+t).classList.add('on');
  hideFloating();
  if (t === 'bible') { renderView(); }
  else {
    renderBookmarks();
    document.getElementById('btnBack').disabled = false;
    document.getElementById('hdrLogo').style.display = 'none';
    document.getElementById('hdrTitle').style.display = 'block';
    document.getElementById('hdrTitle').innerText = 'ë‚´ ë¶ë§ˆí¬';
    document.getElementById('hdrAiBtn').style.display = 'none';
  }
}

/* ===== êµ¬/ì‹ ì•½ ===== */
function setT(t) {
  S.t = t;
  document.querySelectorAll('.t-btn').forEach(b => b.classList.toggle('on', b.id === 't-'+t));
  renderBooks();
}

/* ===== ì±… ===== */
function renderBooks() {
  document.getElementById('bookGrid').innerHTML = BOOKS
    .filter(b => b.t === S.t)
    .map(b => `
      <div class="book-card ${S.bk && S.bk.id === b.id ? 'last-visited' : ''}" onclick="goChList('${b.id}')">
        <div class="book-card-name">${b.name}</div>
        <div class="book-card-sub">${b.c}ì¥</div>
      </div>`).join('');
}

/* ===== ì¥ ===== */
function renderChList() {
  if (!S.bk) return;
  document.getElementById('chGrid').innerHTML = Array.from({length: S.bk.c}, (_, i) => `
    <div class="ch-btn ${S.ch === i+1 ? 'last-visited' : ''}" onclick="goRead(${i+1})">${i+1}</div>
  `).join('');
}

function goChList(bid) {
  S.bk = BOOKS.find(b => b.id === bid);
  S.view = 'chapter'; S.hist.push('chapter'); renderView();
  document.getElementById('bkSummaryWrap').innerHTML = `
    <button class="book-summary-btn" onclick="openBookAi()">âœ¨ ${S.bk.name} ì „ì²´ AI ìš”ì•½ ë³´ê¸°</button>`;
  renderChList();
}

function goRead(ch) {
  S.ch = ch; S.view = 'read'; S.hist.push('read');
  renderView(); updateProgress(); loadVerses();
}

/* ===== ì§„í–‰ ìƒí™© ===== */
function updateProgress() {
  if (!S.bk) return;
  const pct = Math.round((S.ch / S.bk.c) * 100);
  document.getElementById('progressInfo').innerHTML = `<b>${S.bk.name}</b> &nbsp;${S.ch} / ${S.bk.c}ì¥`;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressPct').innerText = pct + '%';
}

/* ===== ì ˆ ì„ íƒ â†’ í”Œë¡œíŒ… ===== */
function selectVerse(idx) {
  const isSame = (selectedVerseIdx === idx);
  document.querySelectorAll('.verse-row').forEach(el => el.classList.remove('hl'));
  if (isSame) { selectedVerseIdx = -1; hideFloating(); return; }
  document.getElementById(`verse-${idx}`).classList.add('hl');
  selectedVerseIdx = idx;
  const lbl = document.getElementById('floatLabel');
  lbl.innerText = `${S.bk.name} ${S.ch}:${idx+1}ì ˆ`;
  lbl.classList.add('show');
  document.getElementById('floatingActions').classList.add('show');
}

function hideFloating() {
  selectedVerseIdx = -1;
  document.getElementById('floatLabel').classList.remove('show');
  document.getElementById('floatingActions').classList.remove('show');
  document.querySelectorAll('.verse-row').forEach(el => el.classList.remove('hl'));
}

function floatBookmark() {
  if (selectedVerseIdx < 0) return;
  const verseText = S.cache[`${S.bk.id}_${S.ch}`]?.[selectedVerseIdx];
  if (!verseText) return;
  let bms = getBookmarks();
  if (bms.find(b => b.bookId === S.bk.id && b.chapter === S.ch && b.verseIdx === selectedVerseIdx)) {
    alert('ì´ë¯¸ ì €ì¥ëœ ë§ì”€ì´ì•¼!'); return;
  }
  bms.push({ id: Date.now(), bookId: S.bk.id, bookName: S.bk.name, chapter: S.ch, verseIdx: selectedVerseIdx, text: verseText });
  saveBookmarks(bms);
  alert(`${S.bk.name} ${S.ch}:${selectedVerseIdx+1} ì €ì¥ë¨ ğŸ”–`);
}

function floatExplain() {
  if (selectedVerseIdx < 0) return;
  explainVerse(selectedVerseIdx);
}

/* ===== ë³¸ë¬¸ ===== */
async function loadVerses() {
  hideFloating();
  const wrap = document.getElementById('versesWrap');
  wrap.innerHTML = `<div style="text-align:center;padding:60px 20px;color:var(--text3)">
    <div class="typing-dot" style="justify-content:center"><span></span><span></span><span></span></div>
    <div style="margin-top:12px;font-size:13px">ë§ì”€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>`;
  try {
    const res = await fetch(`${WORKER_URL}/bible?book=${S.bk.id}&chapter=${S.ch}`);
    const data = await res.json();
    S.cache[`${S.bk.id}_${S.ch}`] = data.verses;
    wrap.innerHTML = data.verses.map((v, i) => `
      <div class="verse-row" id="verse-${i}" onclick="selectVerse(${i})" style="animation-delay:${Math.min(i*0.02,0.4)}s">
        <div class="vn">${i+1}</div>
        <div class="vt">${v}</div>
      </div>`).join('');
    window.scrollTo(0, 0);
  } catch(e) {
    wrap.innerHTML = `<div style="padding:30px;text-align:center;color:var(--text3)">ë³¸ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ ğŸ˜¢<br>ì ê¹ í›„ ë‹¤ì‹œ ëˆŒëŸ¬ë´</div>`;
  }
}

/* ===== ë·° ===== */
function renderView() {
  document.getElementById('vHome').style.display = S.view === 'home' ? 'block' : 'none';
  document.getElementById('vChapter').style.display = S.view === 'chapter' ? 'block' : 'none';
  document.getElementById('vRead').style.display = S.view === 'read' ? 'block' : 'none';

  const isBm = document.getElementById('tab-bookmarks').classList.contains('on');
  document.getElementById('btnBack').disabled = (S.hist.length <= 1) && !isBm;

  const logo = document.getElementById('hdrLogo');
  const title = document.getElementById('hdrTitle');
  const ai = document.getElementById('hdrAiBtn');
  if (S.view === 'home') {
    logo.style.display = 'flex'; title.style.display = 'none'; ai.style.display = 'none';
  } else {
    logo.style.display = 'none'; title.style.display = 'block';
    title.innerText = S.view === 'chapter' ? S.bk.name : `${S.bk.name} ${S.ch}ì¥`;
    ai.style.display = S.view === 'read' ? 'flex' : 'none';
  }
}

function goBack() {
  if (document.getElementById('tab-bookmarks').classList.contains('on')) { switchTab('bible'); return; }
  if (S.hist.length <= 1) return;
  S.hist.pop(); S.view = S.hist[S.hist.length-1];
  hideFloating();
  if (S.view === 'home') renderBooks();
  if (S.view === 'chapter') renderChList();
  renderView();
}

function goHome() {
  if (document.getElementById('tab-bookmarks').classList.contains('on')) switchTab('bible');
  S.view = 'home'; S.hist = ['home'];
  hideFloating(); renderBooks(); renderView();
}

function changeCh(d) {
  let n = S.ch + d;
  let idx = BOOKS.findIndex(b => b.id === S.bk.id);
  if (n > S.bk.c) {
    if (idx < BOOKS.length-1) { S.bk = BOOKS[idx+1]; S.ch = 1; }
    else { alert("ë§ˆì§€ë§‰ ì¥ì´ì•¼! ğŸ™"); return; }
  } else if (n < 1) {
    if (idx > 0) { S.bk = BOOKS[idx-1]; S.ch = S.bk.c; }
    else { alert("ì²« ë²ˆì§¸ ì¥ì´ì•¼! ğŸ™"); return; }
  } else { S.ch = n; }
  renderView(); updateProgress(); loadVerses();
}

/* ===== ë¶ë§ˆí¬ ===== */
function getBookmarks() { return JSON.parse(localStorage.getItem('bible_bm') || '[]'); }
function saveBookmarks(b) { localStorage.setItem('bible_bm', JSON.stringify(b)); }

function renderBookmarks() {
  const bms = getBookmarks();
  const wrap = document.getElementById('bmWrap');
  if (!bms.length) {
    wrap.innerHTML = '<div class="bm-empty">ì•„ì§ ì €ì¥ëœ ë¶ë§ˆí¬ê°€ ì—†ì–´ ğŸ™<br>ì„±ê²½ ì½ë‹¤ ë§ˆìŒì— ë“œëŠ” êµ¬ì ˆ<br>ëˆŒëŸ¬ì„œ ì €ì¥í•´ë´!</div>';
    return;
  }
  let html = `<div class="bm-header">
    <span style="font-weight:700;color:var(--text2)">ì´ ${bms.length}ê°œ</span>
    <button class="bm-clear-btn" onclick="clearAllBookmarks()">ì „ì²´ ì‚­ì œ</button>
  </div><div class="bm-list">`;
  [...bms].reverse().forEach(b => {
    html += `<div class="bm-card">
      <div class="bm-top">
        <div class="bm-title" onclick="goToBookmark('${b.bookId}',${b.chapter})">ğŸ“– ${b.bookName} ${b.chapter}:${b.verseIdx+1} â†’</div>
        <button class="bm-del-btn" onclick="deleteBookmark(${b.id})">ğŸ—‘</button>
      </div>
      <div style="font-family:'Noto Serif KR',serif;font-size:15px;line-height:1.85;color:var(--text2)">${b.text}</div>
    </div>`;
  });
  wrap.innerHTML = html + '</div>';
}
function deleteBookmark(id) {
  if (!confirm('ì´ ë¶ë§ˆí¬ ì‚­ì œí• ê¹Œ?')) return;
  saveBookmarks(getBookmarks().filter(b => b.id !== id)); renderBookmarks();
}
function clearAllBookmarks() {
  if (!confirm('ì „ë¶€ ì‚­ì œí• ê¹Œ? ë˜ëŒë¦´ ìˆ˜ ì—†ì–´!')) return;
  saveBookmarks([]); renderBookmarks();
}
function goToBookmark(bookId, ch) {
  switchTab('bible');
  S.bk = BOOKS.find(b => b.id === bookId); S.hist = ['home','chapter']; goRead(ch);
}

/* ===== AI ===== */
async function showAiSheet(title, prompt) {
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('aiSheet').classList.add('on');
  document.getElementById('shTitle').innerText = title;
  const body = document.getElementById('shBody');
  body.innerHTML = '<div class="typing-dot"><span></span><span></span><span></span></div>';
  try {
    const res = await fetch(`${WORKER_URL}/ai`, { method:'POST', body: JSON.stringify({ prompt }) });
    const data = await res.json();
    body.innerHTML = `<div class="ai-content">${
      data.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')
    }</div>`;
  } catch(e) {
    body.innerHTML = '<div class="ai-content" style="color:var(--text3)">ì—°ê²° ì‹¤íŒ¨ ğŸ˜¢ ì ê¹ í›„ ë‹¤ì‹œ ëˆŒëŸ¬ë´</div>';
  }
}

function openChapterAi() {
  showAiSheet(`${S.bk.name} ${S.ch}ì¥ ìš”ì•½`,
    `${S.bk.name} ${S.ch}ì¥ ë§ì”€ì„ ì²˜ìŒ ì„±ê²½ ì½ëŠ” ì¹œêµ¬í•œí…Œ ì–˜ê¸°í•´ì£¼ë“¯ì´ ì‰½ê³  ì¬ë°Œê²Œ ë°˜ë§ë¡œ ìš”ì•½í•´ì¤˜. ì´ëª¨ì§€ë„ ì ë‹¹íˆ ì¨ì¤˜.`);
}
function openBookAi() {
  showAiSheet(`${S.bk.name} ì „ì²´ ìš”ì•½`,
    `${S.bk.name} ì„±ê²½ ì „ì²´ë¥¼ ì²˜ìŒ ì ‘í•˜ëŠ” MZì„¸ëŒ€ ì¹œêµ¬í•œí…Œ ì„¤ëª…í•´ì£¼ë“¯ ì¬ë°Œê³  ì‰½ê²Œ ë°˜ë§ë¡œ ìš”ì•½í•´ì¤˜. í•µì‹¬ ë©”ì‹œì§€ì™€ ì˜¤ëŠ˜ë‚  ì ìš© í¬ì¸íŠ¸ í¬í•¨, ì´ëª¨ì§€ë„ ì ë‹¹íˆ ì¨ì¤˜.`);
}
function explainVerse(idx) {
  const verseText = S.cache[`${S.bk.id}_${S.ch}`]?.[idx];
  if (!verseText) return;
  showAiSheet(`${S.bk.name} ${S.ch}:${idx+1} í•´ì„¤`,
    `"${verseText}" (${S.bk.name} ${S.ch}ì¥ ${idx+1}ì ˆ) ì´ ë§ì”€ì„ ì„±ê²½ ì²˜ìŒ ì½ëŠ” ì¹œêµ¬í•œí…Œ ì„¤ëª…í•´ì£¼ë“¯ ì‰½ê³  ì¬ë°Œê²Œ ë°˜ë§ë¡œ í•´ì„¤í•´ì¤˜. ì˜ì  ì˜ë¯¸ë‘ ì‹¤ìƒí™œ ì ìš©ë²•ë„ ì•Œë ¤ì¤˜. ì´ëª¨ì§€ë„ ì ë‹¹íˆ.`);
}
function closeAi() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('aiSheet').classList.remove('on');
}

/* ===== ì˜¤ëŠ˜ì˜ ë§ì”€ ===== */
function loadDailyVerse() {
  const dv = DAILY[new Date().getDate() % DAILY.length];
  document.getElementById('dailyText').innerText = dv.text;
  document.getElementById('dailyRef').innerText = 'â€” ' + dv.ref;
  document.getElementById('dailyBanner').style.display = 'block';
}

/* ===== ì´ˆê¸°í™” ===== */
window.onload = () => { applyTheme(currentTheme); renderBooks(); renderView(); loadDailyVerse(); };
</script>
</body>
</html>
