<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë§ì”€ ì„±ê²½</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;700&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #faf8f3; --bg2: #f3ede2; --surface: #ffffff;
  --brown: #6b4f2e; --brown2: #4a3318; --amber: #c07830;
  --amber-l: #f0d4a8; --amber-ll: #fdf5e8; --text: #2a2018;
  --text2: #6e5c44; --text3: #a89880; --border: #ddd5c2;
  --border2: #ede7d8; --sh: 0 2px 10px rgba(80,55,20,.07);
  --r: 13px; --tr: .2s cubic-bezier(.4,0,.2,1);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}

/* í—¤ë” */
.hdr{position:sticky;top:0;z-index:200;background:rgba(250,248,243,.95);backdrop-filter:blur(14px);border-bottom:1.5px solid var(--border);height:56px;display:flex;align-items:center;padding:0 14px;gap:8px;}
.hdr-btn{width:36px;height:36px;border-radius:9px;border:1.5px solid var(--border);background:var(--surface);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
.hdr-title{flex:1;text-align:center;font-family:'Noto Serif KR',serif;font-size:17px;font-weight:700;color:var(--brown2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hdr-ai-btn{display:flex;align-items:center;gap:5px;padding:6px 11px;border-radius:18px;background:linear-gradient(135deg,#fdf0d8,#fbe3b8);border:1.5px solid var(--amber);color:var(--amber);font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;}

/* íƒ­ë°” */
.tabbar{display:flex;background:var(--surface);border-bottom:1.5px solid var(--border);padding:0 8px;position:sticky;top:56px;z-index:190;}
.tab{flex:1;padding:12px 2px 10px;border:none;background:none;color:var(--text3);cursor:pointer;font-size:13px;font-weight:600;border-bottom:2.5px solid transparent;}
.tab.on{color:var(--brown);border-bottom-color:var(--amber)}

/* í˜ì´ì§€ ë ˆì´ì•„ì›ƒ */
.page{display:none}.page.on{display:block}
.home-hero{background:linear-gradient(160deg,#fff8ee 0%,#f5e8d0 100%);padding:32px 20px 24px;border-bottom:1.5px solid var(--border2);text-align:center;}
.book-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;padding:14px 12px 80px}
.book-card{background:var(--surface);border:1.5px solid var(--border2);border-radius:var(--r);padding:13px 8px 10px;cursor:pointer;text-align:center;box-shadow:var(--sh);}

/* ì¥/ì ˆ ì„ íƒ */
.ch-grid, .v-grid {display: grid; grid-template-columns: repeat(auto-fill, minmax(42px, 1fr)); gap: 8px; padding: 14px; padding-bottom: 80px;}
.ch-btn, .v-btn {aspect-ratio: 1; border-radius: 8px; background: var(--surface); border: 1.5px solid var(--border2); color: var(--text2); font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; box-shadow: var(--sh); cursor: pointer;}

/* ë³¸ë¬¸ ì½ê¸° */
.verses-wrap{padding:14px; padding-bottom: 90px;}
.verse-row{display:flex; gap:12px; padding:12px 10px; border-radius:10px; margin-bottom: 6px; cursor:pointer;}
.vn{font-size:12px; color:var(--amber); font-weight:700; min-width:22px; text-align:right; padding-top:4px;}
.vt-wrap{flex:1; display:flex; flex-direction:column;}
.vt{font-family:'Noto Serif KR',serif; font-size:17px; line-height:1.85; color:var(--text); word-break:keep-all;}

/* í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼ ë° ì ˆ ì•¡ì…˜ ë²„íŠ¼ ì¶”ê°€ */
.verse-row.hl{background:rgba(192,120,48,.08); border-left: 3px solid var(--amber);}
.verse-actions{display:none; margin-top:12px; gap:8px; justify-content:flex-end;}
.verse-row.hl .verse-actions{display:flex;}
.v-action-btn{padding:6px 14px; border-radius:14px; background:var(--surface); border:1.5px solid var(--amber); color:var(--amber); font-size:12px; font-weight:700; cursor:pointer;}

/* í•˜ë‹¨ ë„¤ë¹„ */
.ch-nav{position:fixed; bottom:0; left:0; right:0; display:flex; gap:10px; padding:12px 14px; background:rgba(250,248,243,.96); border-top:1.5px solid var(--border); z-index: 100;}
.ch-nav-btn{flex:1; padding:12px; border-radius:10px; background:var(--surface); border:1.5px solid var(--border); font-weight:600; cursor:pointer;}

/* AI ì‹œíŠ¸ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:300;display:none;}
.ai-sheet{position:fixed;bottom:0;left:0;right:0;z-index:310;background:var(--surface);border-radius:24px 24px 0 0;padding:20px;transform:translateY(100%);transition:transform .3s;max-height:80vh;overflow-y:auto;}
.ai-sheet.on{transform:translateY(0)}
</style>
</head>
<body>

<div class="hdr">
  <button class="hdr-btn" onclick="goHome()">ğŸ </button>
  <button class="hdr-btn" id="btnBack" onclick="goBack()" disabled>â†</button>
  <div class="hdr-title" id="hdrTitle">âœ ë§ì”€</div>
  <button class="hdr-ai-btn" id="hdrAiBtn" style="display:none" onclick="openChapterAi()">âœ¨ ì „ì²´ ìš”ì•½</button>
  <button class="hdr-btn" onclick="switchTab('bookmarks')">ğŸ”–</button>
</div>

<div class="tabbar">
  <button class="tab on" id="tab-bible" onclick="switchTab('bible')">ì„±ê²½</button>
  <button class="tab" id="tab-bookmarks" onclick="switchTab('bookmarks')">ë¶ë§ˆí¬</button>
</div>

<div id="bible-page" class="page on">
  <div id="vHome">
    <div class="home-hero"><div class="home-title" style="font-family:'Noto Serif KR';font-size:28px;">ë§ì”€</div><div style="font-size:12px;color:var(--text3)">ê°œì—­í•œê¸€ (KRV)</div></div>
    <div style="display:flex;gap:8px;padding:14px;"><button class="t-btn on" id="t-old" onclick="setT('old')">êµ¬ì•½</button><button class="t-btn" id="t-new" onclick="setT('new')">ì‹ ì•½</button></div>
    <div class="book-grid" id="bookGrid"></div>
  </div>
  <div id="vChapter" style="display:none"><div class="ch-grid" id="chGrid"></div></div>
  <div id="vVerse" style="display:none"><div class="v-grid" id="vGrid"></div></div>
  <div id="vRead" style="display:none"><div class="verses-wrap" id="versesWrap"></div><div class="ch-nav"><button class="ch-nav-btn" id="prevBtn" onclick="changeCh(-1)">ì´ì „ ì¥</button><button class="ch-nav-btn" id="nextBtn" onclick="changeCh(1)">ë‹¤ìŒ ì¥</button></div></div>
</div>

<div id="bookmarks-page" class="page"><div id="bmList" style="padding:14px"></div></div>

<div class="overlay" id="overlay" onclick="closeAi()"></div>
<div class="ai-sheet" id="aiSheet"><h3 id="shTitle" style="margin-bottom:15px;font-family:'Noto Serif KR'">AI ìš”ì•½</h3><div id="shBody" style="line-height:1.8;font-size:16px;">ë¶„ì„ ì¤‘...</div></div>

<script>
// ë³¸ì¸ì˜ ì›Œì»¤ URL
const WORKER_URL = 'https://bible-ai-worker.hdh1231.workers.dev';

const BOOKS=[
  {id:"gen",name:"ì°½ì„¸ê¸°",abbr:"ì°½",t:"old",c:50},{id:"exo",name:"ì¶œì• êµ½ê¸°",abbr:"ì¶œ",t:"old",c:40},{id:"lev",name:"ë ˆìœ„ê¸°",abbr:"ë ˆ",t:"old",c:27},{id:"num",name:"ë¯¼ìˆ˜ê¸°",abbr:"ë¯¼",t:"old",c:36},{id:"deu",name:"ì‹ ëª…ê¸°",abbr:"ì‹ ",t:"old",c:34},{id:"jos",name:"ì—¬í˜¸ìˆ˜ì•„",abbr:"ìˆ˜",t:"old",c:24},{id:"jdg",name:"ì‚¬ì‚¬ê¸°",abbr:"ì‚¿",t:"old",c:21},{id:"rut",name:"ë£»ê¸°",abbr:"ë£»",t:"old",c:4},{id:"1sa",name:"ì‚¬ë¬´ì—˜ìƒ",abbr:"ì‚¼ìƒ",t:"old",c:31},{id:"2sa",name:"ì‚¬ë¬´ì—˜í•˜",abbr:"ì‚¼í•˜",t:"old",c:24},{id:"1ki",name:"ì—´ì™•ê¸°ìƒ",abbr:"ì™•ìƒ",t:"old",c:22},{id:"2ki",name:"ì—´ì™•ê¸°í•˜",abbr:"ì™•í•˜",t:"old",c:25},{id:"1ch",name:"ì—­ëŒ€ìƒ",abbr:"ëŒ€ìƒ",t:"old",c:29},{id:"2ch",name:"ì—­ëŒ€í•˜",abbr:"ëŒ€í•˜",t:"old",c:36},{id:"ezr",name:"ì—ìŠ¤ë¼",abbr:"ìŠ¤",t:"old",c:10},{id:"neh",name:"ëŠí—¤ë¯¸ì•¼",abbr:"ëŠ",t:"old",c:13},{id:"est",name:"ì—ìŠ¤ë”",abbr:"ì—",t:"old",c:10},{id:"job",name:"ìš¥ê¸°",abbr:"ìš¥",t:"old",c:42},{id:"psa",name:"ì‹œí¸",abbr:"ì‹œ",t:"old",c:150},{id:"pro",name:"ì ì–¸",abbr:"ì ",t:"old",c:31},{id:"ecc",name:"ì „ë„ì„œ",abbr:"ì „",t:"old",c:12},{id:"sng",name:"ì•„ê°€",abbr:"ì•„",t:"old",c:8},{id:"isa",name:"ì´ì‚¬ì•¼",abbr:"ì‚¬",t:"old",c:66},{id:"jer",name:"ì˜ˆë ˆë¯¸ì•¼",abbr:"ë ˜",t:"old",c:52},{id:"lam",name:"ì˜ˆë ˆë¯¸ì•¼ì• ê°€",abbr:"ì• ",t:"old",c:5},{id:"ezk",name:"ì—ìŠ¤ê²”",abbr:"ê²”",t:"old",c:48},{id:"dan",name:"ë‹¤ë‹ˆì—˜",abbr:"ë‹¨",t:"old",c:12},{id:"hos",name:"í˜¸ì„¸ì•„",abbr:"í˜¸",t:"old",c:14},{id:"jol",name:"ìš”ì—˜",abbr:"ìšœ",t:"old",c:3},{id:"amo",name:"ì•„ëª¨ìŠ¤",abbr:"ì•”",t:"old",c:9},{id:"oba",name:"ì˜¤ë°”ëŒœ",abbr:"ì˜µ",t:"old",c:1},{id:"jon",name:"ìš”ë‚˜",abbr:"ìš˜",t:"old",c:4},{id:"mic",name:"ë¯¸ê°€",abbr:"ë¯¸",t:"old",c:7},{id:"nah",name:"ë‚˜í›”",abbr:"ë‚˜",t:"old",c:3},{id:"hab",name:"í•˜ë°•êµ­",abbr:"í•©",t:"old",c:3},{id:"zep",name:"ìŠ¤ë°”ëƒ",abbr:"ìŠµ",t:"old",c:3},{id:"hag",name:"í•™ê°œ",abbr:"í•™",t:"old",c:2},{id:"zec",name:"ìŠ¤ê°€ë´",abbr:"ìŠ¥",t:"old",c:14},{id:"mal",name:"ë§ë¼ê¸°",abbr:"ë§",t:"old",c:4},
  {id:"mat",name:"ë§ˆíƒœë³µìŒ",abbr:"ë§ˆ",t:"new",c:28},{id:"mrk",name:"ë§ˆê°€ë³µìŒ",abbr:"ë§‰",t:"new",c:16},{id:"luk",name:"ëˆ„ê°€ë³µìŒ",abbr:"ëˆ…",t:"new",c:24},{id:"jhn",name:"ìš”í•œë³µìŒ",abbr:"ìš”",t:"new",c:21},{id:"act",name:"ì‚¬ë„í–‰ì „",abbr:"í–‰",t:"new",c:28},{id:"rom",name:"ë¡œë§ˆì„œ",abbr:"ë¡¬",t:"new",c:16},{id:"1co",name:"ê³ ë¦°ë„ì „ì„œ",abbr:"ê³ ì „",t:"new",c:16},{id:"2co",name:"ê³ ë¦°ë„í›„ì„œ",abbr:"ê³ í›„",t:"new",c:13},{id:"gal",name:"ê°ˆë¼ë””ì•„ì„œ",abbr:"ê°ˆ",t:"new",c:6},{id:"eph",name:"ì—ë² ì†Œì„œ",abbr:"ì—¡",t:"new",c:6},{id:"php",name:"ë¹Œë¦½ë³´ì„œ",abbr:"ë¹Œ",t:"new",c:4},{id:"col",name:"ê³¨ë¡œìƒˆì„œ",abbr:"ì½œ",t:"new",c:4},{id:"1th",name:"ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ",abbr:"ì‚´ì „",t:"new",c:5},{id:"2th",name:"ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ",abbr:"ì‚´í›„",t:"new",c:3},{id:"1ti",name:"ë””ëª¨ë°ì „ì„œ",abbr:"ë”¤ì „",t:"new",c:6},{id:"2ti",name:"ë””ëª¨ë°í›„ì„œ",abbr:"ë”¤í›„",t:"new",c:4},{id:"tit",name:"ë””ë„ì„œ",abbr:"ë”›",t:"new",c:3},{id:"phm",name:"ë¹Œë ˆëª¬ì„œ",abbr:"ëª¬",t:"new",c:1},{id:"heb",name:"íˆë¸Œë¦¬ì„œ",abbr:"íˆ",t:"new",c:13},{id:"jas",name:"ì•¼ê³ ë³´ì„œ",abbr:"ì•½",t:"new",c:5},{id:"1pe",name:"ë² ë“œë¡œì „ì„œ",abbr:"ë²§ì „",t:"new",c:5},{id:"2pe",name:"ë² ë“œë¡œí›„ì„œ",abbr:"ë²§í›„",t:"new",c:3},{id:"1jn",name:"ìš”í•œ1ì„œ",abbr:"ìš”ì¼",t:"new",c:5},{id:"2jn",name:"ìš”í•œ2ì„œ",abbr:"ìš”ì´",t:"new",c:1},{id:"3jn",name:"ìš”í•œ3ì„œ",abbr:"ìš”ì‚¼",t:"new",c:1},{id:"jud",name:"ìœ ë‹¤ì„œ",abbr:"ìœ ",t:"new",c:1},{id:"rev",name:"ìš”í•œê³„ì‹œë¡",abbr:"ê³„",t:"new",c:22}
];

let S = { view:'home', t:'old', bk:null, ch:1, hist:['home'], cache:{} };
let selectedVerseIdx = -1; // í˜„ì¬ ì„ íƒëœ ì ˆ ê¸°ë¡

function switchTab(t){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('on'));
  document.getElementById(t+'-page').classList.add('on');
  document.getElementById('tab-'+t).classList.add('on');
  if(t==='bible') renderView();
}

function setT(t){ S.t=t; document.querySelectorAll('.t-btn').forEach(b=>b.classList.toggle('on', b.id==='t-'+t)); renderBooks(); }

function renderBooks(){
  const grid = document.getElementById('bookGrid');
  grid.innerHTML = BOOKS.filter(b=>b.t===S.t).map(b=>`
    <div class="book-card" onclick="goChList('${b.id}')">
      <div style="font-family:'Noto Serif KR';font-size:18px;font-weight:700;color:var(--brown2)">${b.abbr}</div>
      <div style="font-size:11px;color:var(--text3)">${b.name}</div>
    </div>`).join('');
}

function goChList(bid){
  S.bk = BOOKS.find(b=>b.id===bid); S.view='chapter'; S.hist.push('chapter'); renderView();
  const grid = document.getElementById('chGrid');
  grid.innerHTML = Array.from({length:S.bk.c}, (_,i)=>`<div class="ch-btn" onclick="goRead(${i+1})">${i+1}</div>`).join('');
}

function goRead(ch){
  S.ch = ch; S.view='read'; S.hist.push('read'); renderView(); loadVerses();
}

// 1. í•˜ë‚˜ì”©ë§Œ ì„ íƒë˜ë„ë¡ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
function selectVerse(idx) {
  const isCurrentlySelected = (selectedVerseIdx === idx);
  // ì „ì²´ í•˜ì´ë¼ì´íŠ¸ ì´ˆê¸°í™”
  document.querySelectorAll('.verse-row').forEach(el => el.classList.remove('hl'));
  
  if (isCurrentlySelected) {
    selectedVerseIdx = -1; // ë™ì¼í•œ ê±¸ ë‹¤ì‹œ ëˆ„ë¥´ë©´ í•´ì œ
  } else {
    document.getElementById(`verse-${idx}`).classList.add('hl');
    selectedVerseIdx = idx; // ìƒˆë¡­ê²Œ ì„ íƒ
  }
}

async function loadVerses(){
  const wrap = document.getElementById('versesWrap');
  wrap.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text3)">ë§ì”€ì„ ì‚¬ë¬¼í•¨ì—ì„œ êº¼ë‚´ì˜¤ëŠ” ì¤‘...</div>';
  selectedVerseIdx = -1; // ì¥ ì´ë™ ì‹œ ì„ íƒ ì´ˆê¸°í™”
  
  try {
    const res = await fetch(`${WORKER_URL}/bible?book=${S.bk.id}&chapter=${S.ch}`);
    const data = await res.json();
    S.cache[`${S.bk.id}_${S.ch}`] = data.verses;
    wrap.innerHTML = data.verses.map((v,i)=>`
      <div class="verse-row" id="verse-${i}" onclick="selectVerse(${i})">
        <div class="vn">${i+1}</div>
        <div class="vt-wrap">
          <div class="vt">${v}</div>
          <div class="verse-actions">
            <button class="v-action-btn" onclick="toggleBookmark(${i}, event)">ğŸ”– ë¶ë§ˆí¬</button>
            <button class="v-action-btn" onclick="explainVerse(${i}, event)">âœ¨ AI í•´ì„¤</button>
          </div>
        </div>
      </div>`).join('');
    window.scrollTo(0,0);
  } catch(e) { wrap.innerHTML = '<div style="padding:20px;">ë³¸ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>'; }
}

function renderView(){
  document.getElementById('vHome').style.display = S.view==='home'?'block':'none';
  document.getElementById('vChapter').style.display = S.view==='chapter'?'block':'none';
  document.getElementById('vRead').style.display = S.view==='read'?'block':'none';
  document.getElementById('hdrAiBtn').style.display = S.view==='read'?'flex':'none';
  document.getElementById('btnBack').disabled = S.hist.length <= 1;
  const title = document.getElementById('hdrTitle');
  if(S.view==='home') title.innerText = 'âœ ë§ì”€';
  else if(S.view==='chapter') title.innerText = S.bk.name;
  else title.innerText = `${S.bk.name} ${S.ch}ì¥`;
}

function goBack(){
  if(S.hist.length<=1) return;
  S.hist.pop(); S.view = S.hist[S.hist.length-1]; renderView();
}

function goHome(){ S.view='home'; S.hist=['home']; renderView(); }

function changeCh(d){
  let n = S.ch + d; if(n<1 || n>S.bk.c) return;
  S.ch = n; renderView(); loadVerses();
}

// ê³µí†µ AI API í†µì‹  í•¨ìˆ˜
async function showAiSheet(title, promptText) {
  document.getElementById('overlay').style.display='block';
  document.getElementById('aiSheet').classList.add('on');
  document.getElementById('shTitle').innerText = title;
  const body = document.getElementById('shBody'); 
  body.innerText = 'ë¶„ì„ ì¤‘...';
  try {
    const res = await fetch(`${WORKER_URL}/ai`, {
      method:'POST', body: JSON.stringify({ prompt: promptText })
    });
    const data = await res.json();
    body.innerHTML = data.text.replace(/\n/g,'<br>');
  } catch(e){ body.innerText='AI í†µì‹  ì‹¤íŒ¨'; }
}

// ìƒë‹¨ ì¥ ì „ì²´ ìš”ì•½
function openChapterAi(){
  showAiSheet('AI ì¥ ìš”ì•½', `${S.bk.name} ${S.ch}ì¥ ë§ì”€ì„ í˜„ëŒ€ì–´ë¡œ ìƒí™©ì— ë§ê²Œ ìš”ì•½í•´ì¤˜.`);
}

// 2 & 3. ê° ì ˆ AI í•´ì„¤
function explainVerse(idx, event) {
  event.stopPropagation(); // ë²„íŠ¼ í´ë¦­ ì‹œ selectVerse ë°©ì§€
  const verseText = S.cache[`${S.bk.id}_${S.ch}`][idx];
  const title = `${S.bk.name} ${S.ch}ì¥ ${idx+1}ì ˆ í•´ì„¤`;
  const prompt = `${S.bk.name} ${S.ch}ì¥ ${idx+1}ì ˆ ("${verseText}") ë§ì”€ì˜ ì˜ë¯¸ë¥¼ í˜„ëŒ€ì¸ë“¤ì´ ì´í•´í•˜ê¸° ì‰½ê²Œ ì˜ì ì¸ ì˜ë¯¸ì™€ ì ìš©ì ì„ í¬í•¨í•˜ì—¬ í•´ì„¤í•´ì¤˜.`;
  showAiSheet(title, prompt);
}

// ë¶ë§ˆí¬ í´ë¦­ íš¨ê³¼
function toggleBookmark(idx, event) {
  event.stopPropagation(); // ë²„íŠ¼ í´ë¦­ ì‹œ selectVerse ë°©ì§€
  alert(`${S.bk.name} ${S.ch}ì¥ ${idx+1}ì ˆì´ ë¶ë§ˆí¬ ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  // ì¶”í›„ ë¶ë§ˆí¬ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•˜ëŠ” ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
}

function closeAi(){ document.getElementById('overlay').style.display='none'; document.getElementById('aiSheet').classList.remove('on'); }

window.onload = () => { renderBooks(); renderView(); };
</script>
</body>
</html>
